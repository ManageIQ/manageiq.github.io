<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <script>
    stored_theme = localStorage.getItem('miq-theme');
    theme        = stored_theme && JSON.parse(localStorage.getItem('miq-theme'));

    if (theme === "light-theme") {
      document.querySelector('html').classList.add("light-theme");
    }

    if (theme === "dark-theme") {
      document.querySelector('html').classList.add("dark-theme");
    }
  </script>

  <link type="text/css" rel="stylesheet" href="/assets/main-72fb4f5b36dd952a472e11bcb9bd0033f67ce60d480cf7fbdcd084f2c00fa845.css">
  <link rel="canonical" href="http://manageiq.org/docs/reference/latest/installing_on_openshift_container_platform/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/reference/jansa/installing_on_openshift_container_platform/index">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li class="active">
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li>
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<div class="doc_menu-heading">
  Jansa
</div>

<ul class="menu menu-toplevel" id=ref_menu_jansa>


  <li class="menu-parent">
    
    <a href="#">
      Installation
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_aws/index.html">
      Amazon Web Services (AWS)
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_microsoft_azure/index.html">
      Microsoft Azure
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_google_compute_engine/index.html">
      Google Compute Engine
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_vmware_vsphere/index.html">
      VMware vSphere
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_red_hat_enterprise_linux_openstack_platform/index.html">
      Red Hat Enterprise OpenStack Platform
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_red_hat_virtualization/index.html">
      Red Hat Enterprise Virtualization
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/installing_on_scvmm/index.html">
      Microsoft System Center Virtual Machine Manager (SCVMM)
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Configuration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/deployment_planning_guide/index.html">
      Deployment Planning Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/general_configuration/index.html">
      General Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/high_availability_guide/index.html">
      High Availability Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/appliance_hardening_guide/index.html">
      Appliance Hardening Guide
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Administration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/monitoring_alerts_and_reporting/index.html">
      Monitoring, Alerts, and Reporting
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/policies_and_profiles_guide/index.html">
      Policies and Profiles Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/managing_infrastructure_and_inventory/index.html">
      Managing Infrastructure and Inventory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/managing_providers/index.html">
      Managing Providers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/provisioning_virtual_machines_and_hosts/index.html">
      Provisioning Virtual Machines and Hosts
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/scripting_actions/index.html">
      Scripting Actions in ManageIQ
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Authentication
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/active_directory.html">
      Active Directory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/ipa_2fa.html">
      2-Factor-Authentication with IPA
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/ipa_ad_trust.html">
      IPA/AD Trust
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/ldap.html">
      LDAP
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/saml.html">
      SAML
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/auth/openid_connect.html">
      OpenID-Connect
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Integration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/integration_with_aws_cloudformation_and_openstack_heat/index.html">
      AWS CloudFormation and OpenStack Heat
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/integration_with_servicenow/index.html">
      ServiceNow
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Reference
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/rest_api/index.html">
      ManageIQ REST API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/jansa/methods_available_for_automation/index.html">
      Methods Available for Automation
    </a>
    
  </li>


      </ul>
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc user_doc">
      

      <div class="doc-content">
        
        <div class="doc-versions">
          <span class="label">Versions: </span>
          
            <span>
              <a href="">
                Latest
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Oparin
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Najdorf
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Morphy
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Lasker
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Kasparov
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span class="active" >
              <a href="">
                Jansa
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Ivanchuk
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Hammer
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Gaprindashvili
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Fine
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="">
                Euwe
              </a>
            </span>
            
          
        </div>
        
        <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#installing-on-openshift-container-platform">Installing on OpenShift Container Platform</a>
<ul>
<li class="toc-entry toc-h2"><a href="#installing-manageiq">Installing ManageIQ</a>
<ul>
<li class="toc-entry toc-h3"><a href="#prerequisites">Prerequisites</a>
<ul>
<li class="toc-entry toc-h4"><a href="#cluster-sizing">Cluster Sizing</a></li>
<li class="toc-entry toc-h4"><a href="#limitations">Limitations</a></li>
<li class="toc-entry toc-h4"><a href="#templates-and-images">Templates and Images</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#preparing-to-deploy-manageiq">Preparing to Deploy ManageIQ</a></li>
<li class="toc-entry toc-h3"><a href="#deploying-the-manageiq-appliance">Deploying the ManageIQ Appliance</a>
<ul>
<li class="toc-entry toc-h4"><a href="#deploying-the-manageiq-appliance-using-an-external-database">Deploying the ManageIQ Appliance Using an External Database</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#verifying-the-configuration">Verifying the Configuration</a></li>
<li class="toc-entry toc-h3"><a href="#logging-into-manageiq">Logging into ManageIQ</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#configuring-external-authentication-to-manageiq">Configuring External Authentication to ManageIQ</a>
<ul>
<li class="toc-entry toc-h3"><a href="#configuring-external-authentication-automatically">Configuring External Authentication Automatically</a>
<ul>
<li class="toc-entry toc-h4"><a href="#supported-authentication-types">Supported Authentication Types</a></li>
<li class="toc-entry toc-h4"><a href="#updating-an-authconfig-map">Updating an authconfig Map</a></li>
<li class="toc-entry toc-h4"><a href="#exporting-a-file-from-an-authconfig-map">Exporting a File from an authconfig Map</a></li>
<li class="toc-entry toc-h4"><a href="#building-the-httpd_configmap_generator-in-a-container">Building the httpd_configmap_generator in a Container</a>
<ul>
<li class="toc-entry toc-h5"><a href="#preparing-to-deploy-the-httpd-configmap-generator-application">Preparing to Deploy the httpd-configmap-generator Application</a></li>
<li class="toc-entry toc-h5"><a href="#deploying-the-httpd-configmap-generator-application">Deploying the httpd-configmap-generator Application</a></li>
<li class="toc-entry toc-h5"><a href="#getting-the-pod-name">Getting the Pod Name</a></li>
<li class="toc-entry toc-h5"><a href="#example-generating-an-authconfig-map-for-external-authentication-against-ipa">Example: Generating an authconfig Map for External Authentication Against IPA</a></li>
<li class="toc-entry toc-h5"><a href="#cleaning-up">Cleaning up</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#defining-the-configuration-map-manually">Defining the Configuration Map Manually</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#managing-manageiq-with-openshift">Managing ManageIQ with OpenShift</a>
<ul>
<li class="toc-entry toc-h3"><a href="#configuring-custom-ssl-certificates-for-manageiq">Configuring Custom SSL Certificates for ManageIQ</a></li>
<li class="toc-entry toc-h3"><a href="#scaling-manageiq-appliances">Scaling ManageIQ Appliances</a></li>
<li class="toc-entry toc-h3"><a href="#creating-a-backup">Creating a Backup</a></li>
<li class="toc-entry toc-h3"><a href="#restoring-to-a-backup">Restoring to a Backup</a></li>
<li class="toc-entry toc-h3"><a href="#updating-manageiq">Updating ManageIQ</a>
<ul>
<li class="toc-entry toc-h4"><a href="#updating-the-manageiq-container-images">Updating the ManageIQ Container Images</a></li>
<li class="toc-entry toc-h4"><a href="#updating-the-manageiq-container-images-and-template">Updating the ManageIQ Container Images and Template</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#uninstalling-manageiq-from-a-project">Uninstalling ManageIQ from a Project</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#troubleshooting-deployment">Troubleshooting Deployment</a></li>
<li class="toc-entry toc-h2"><a href="#appendix">Appendix</a>
<ul>
<li class="toc-entry toc-h3"><a href="#external-authentication-configuration-map-settings">External Authentication Configuration Map Settings</a></li>
<li class="toc-entry toc-h3"><a href="#sample-external-authentication-configuration">Sample External Authentication Configuration</a></li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="installing-on-openshift-container-platform">
<a class="anchor" href="#installing-on-openshift-container-platform" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing on OpenShift Container Platform</h1>

<h2 id="installing-manageiq">
<a class="anchor" href="#installing-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing ManageIQ</h2>

<p>ManageIQ can be installed on OpenShift Container Platform in a
few steps.</p>

<p>This procedure uses a template to deploy a multi-pod
ManageIQ appliance with the database stored in a
persistent volume on OpenShift Container Platform. It provides a
step-by-step setup, including cluster administrative tasks as well as
information and commands for the application developer using the
deployment.</p>

<p>The ultimate goal of the deployment is to be able to deconstruct the
ManageIQ appliance into several containers running on a
pod or a series of pods.</p>

<p>Running the ManageIQ appliance in a series of pods has
several advantages. For example, running each worker in a separate pod
allows OpenShift Container Platform to manage worker processes and
reduce worker memory consumption. OpenShift can also easily scale
workers by adding or removing pods, and perform upgrades by using
images.</p>

<p>There are two options for installing ManageIQ on
OpenShift:</p>

<ul>
  <li>
    <p>During OpenShift Container Platform 3.7 installation:</p>

    <ul>
      <li>When you install OpenShift Container Platform 3.7, you have the
option to install ManageIQ inside OpenShift at the
time. This method leverages the Ansible installer to run and
deploy the ManageIQ template, instead of building
the environment manually. See the <a href="https://access.redhat.com/documentation/en-us/openshift_container_platform/3.7/html-single/release_notes/index#ocp-37-installation">OpenShift Container
Platform 3.7 Release
Notes</a>
for details.</li>
    </ul>
  </li>
  <li>
    <p>Manual install on an existing OpenShift Container Platform
environment:</p>

    <ul>
      <li>Deploy ManageIQ pods using the
ManageIQ template (<em>.yaml</em> file). This is the
method described in this guide.</li>
    </ul>
  </li>
</ul>

<p>After deployment, you can configure the ManageIQ
environment to use any external authentication configurations supported
by ManageIQ.</p>

<h3 id="prerequisites">
<a class="anchor" href="#prerequisites" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prerequisites</h3>

<p>To successfully deploy a ManageIQ appliance on OpenShift
Container Platform, you need a functioning <strong>OpenShift Container
Platform 3.7</strong> install with the following configured:</p>

<ul>
  <li>
    <p>NFS or other compatible volume provider</p>
  </li>
  <li>
    <p>A <code class="language-plaintext highlighter-rouge">cluster-admin</code> user</p>
  </li>
  <li>
    <p>A regular user (such as an application developer)</p>
  </li>
</ul>

<div class="important">

OpenShift Container Platform 3.7 is required for this installation. Red
Hat has not tested this procedure with earlier versions of OpenShift
Container Platform.

</div>

<h4 id="cluster-sizing">
<a class="anchor" href="#cluster-sizing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cluster Sizing</h4>

<p>To avoid deployment failures due to resource starvation, Red Hat
recommends the following minimum cluster size for a test environment:</p>

<ul>
  <li>
    <p>1 master node with at least 8 vCPUs and 12GB RAM</p>
  </li>
  <li>
    <p>2 schedulable nodes with at least 4 vCPUs and 8GB RAM</p>
  </li>
  <li>
    <p>25GB storage for ManageIQ physical volume use</p>
  </li>
</ul>

<p>These recommendations assume ManageIQ is the only
application running on this cluster. Alternatively, you can provision an
infrastructure node to run registry, metrics, router, and logging pods.</p>

<p>Each ManageIQ application pod will consume at least 3GB
RAM on initial deployment (without providers added). RAM consumption
increases depending on the appliance use. For example, after adding
providers, expect higher resource consumption.</p>

<h4 id="limitations">
<a class="anchor" href="#limitations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Limitations</h4>

<p>The following limitations exist when deploying this version of
ManageIQ on OpenShift Container Platform 3.7:</p>

<ul>
  <li>
    <p>This configuration cannot run on public OpenShift (OpenShift.io and
OpenShift Dedicated environments) because of necessary privileges</p>
  </li>
  <li>
    <p>The Embedded Ansible pod must run as a privileged pod</p>
  </li>
  <li>
    <p>OpenShift cannot independently scale workers</p>
  </li>
  <li>
    <p>A highly available database is not supported in PostgreSQL pods</p>
  </li>
</ul>

<h4 id="templates-and-images">
<a class="anchor" href="#templates-and-images" aria-hidden="true"><span class="octicon octicon-link"></span></a>Templates and Images</h4>

<h3 id="preparing-to-deploy-manageiq">
<a class="anchor" href="#preparing-to-deploy-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preparing to Deploy ManageIQ</h3>

<p>To prepare for deploying the ManageIQ appliance to
OpenShift Container Platform, create a project, configure security
contexts, and create persistent storage.</p>

<ol>
  <li>
    <p>As a regular user, log in to OpenShift:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc login -u &lt;user&gt; -p &lt;password&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a project with your desired parameters. The project name
(<code class="language-plaintext highlighter-rouge">&lt;your_project&gt;</code> in this example) is mandatory, but <code class="language-plaintext highlighter-rouge">&lt;description&gt;</code>
and <code class="language-plaintext highlighter-rouge">&lt;display_name&gt;</code> are optional:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc new-project &lt;your_project&gt; \
--description="&lt;description&gt;" \
--display-name="&lt;display_name&gt;"
</code></pre></div>    </div>
  </li>
  <li>
    <p>As the admin user, configure security context constraints (SCCs) for
your OpenShift service accounts:</p>

    <ol>
      <li>
        <p>Add the <code class="language-plaintext highlighter-rouge">cfme-anyuid</code> service account to the <code class="language-plaintext highlighter-rouge">anyuid</code> SCC:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc adm policy add-scc-to-user anyuid system:serviceaccount:&lt;your-project&gt;:cfme-anyuid
</code></pre></div>        </div>
      </li>
      <li>
        <p>Add the <code class="language-plaintext highlighter-rouge">cfme-orchestrator</code> service account to the <code class="language-plaintext highlighter-rouge">anyuid</code> SCC:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc adm policy add-scc-to-user anyuid system:serviceaccount:&lt;your-project&gt;:cfme-orchestrator
</code></pre></div>        </div>
      </li>
      <li>
        <p>Add the <code class="language-plaintext highlighter-rouge">cfme-httpd</code> service account to the <code class="language-plaintext highlighter-rouge">anyuid</code> SCC:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc adm policy add-scc-to-user anyuid system:serviceaccount:&lt;your-project&gt;:cfme-httpd
</code></pre></div>        </div>
      </li>
      <li>
        <p>Add the <code class="language-plaintext highlighter-rouge">cfme-privileged</code> service account to the <code class="language-plaintext highlighter-rouge">privileged</code>
SCC:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc adm policy add-scc-to-user privileged system:serviceaccount:&lt;your-project&gt;:cfme-privileged
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>Verify the SCCs are added correctly to the service accounts and
project:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc describe scc anyuid | grep Users
Users:                  system:serviceaccount:&lt;your-project&gt;:cfme-anyuid,system:serviceaccount:&lt;your-project&gt;:cfme-httpd,system:serviceaccount:&lt;your-project&gt;:cfme-orchestrator
$ oc describe scc privileged | grep Users
Users:                  system:admin,system:serviceaccount:openshift-infra:build-controller,system:serviceaccount:management-infra:management-admin,system:serviceaccount:management-infra:inspector-admin,system:serviceaccount:logging:aggregated-logging-fluentd,system:serviceaccount:&lt;your-project&gt;:cfme-privileged
</code></pre></div>    </div>

    <div class="note">

For more information on SCCs, see the [OpenShift
documentation](https://docs.openshift.com/container-platform/3.7/admin_guide/manage_scc.html).

</div>
  </li>
  <li>
    <p>As the admin user, add the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> service
account to the <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin</code> SCC before the Httpd Configmap
Generator can run.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Users:        system:serviceaccount:&lt;your-namespace&gt;:httpd-configmap-generator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the <code class="language-plaintext highlighter-rouge">view</code> and <code class="language-plaintext highlighter-rouge">edit</code> roles to the <code class="language-plaintext highlighter-rouge">cfme-orchestrator</code> service
account:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc policy add-role-to-user view system:serviceaccount:&lt;your-project&gt;:cfme-orchestrator -n &lt;your-project&gt;
$ oc policy add-role-to-user edit system:serviceaccount:&lt;your-project&gt;:cfme-orchestrator -n &lt;your-project&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>As the admin user, prepare persistent storage for the deployment.
(Skip this step if you have already configured persistent storage.)</p>

    <p>A basic ManageIQ deployment needs at least two
persistent volumes (PVs) to store ManageIQ data. As
the admin user, create two persistent volumes: one to host the
ManageIQ PostgreSQL database, and one to host the
application data.</p>

    <p>Example NFS-backed volume templates are provided by
<code class="language-plaintext highlighter-rouge">cfme-pv-db-example.yaml</code> and <code class="language-plaintext highlighter-rouge">cfme-pv-server-example.yaml</code>,
available from the image stream or repository configured in
<a href="#templates-images">Templates and Images</a>.</p>

    <div class="note">

For NFS-backed volumes, ensure your NFS server firewall is
configured to allow traffic on port 2049 (TCP) from the OpenShift
cluster.

Red Hat recommends setting permissions for the pv-app (privileged
pod volume) as 777, uid/gid 0 (owned by root). For more information
on configuring persistent storage in OpenShift Container Platform,
see the [OpenShift Container Platform Installation and
Configuration](https://access.redhat.com/documentation/en-us/openshift_container_platform/3.7/html-single/installation_and_configuration/#configuring-persistent-storage)
guide.

</div>

    <ol>
      <li>
        <p>Configure your NFS server host details within these files, and
edit any other settings needed to match your environment.</p>
      </li>
      <li>
        <p>Create the two persistent volumes:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc create -f cfme-pv-db-example.yaml
$ oc create -f cfme-pv-server-example.yaml
</code></pre></div>        </div>
      </li>
      <li>
        <p>Process the templates, editing the NFS_HOST parameter
(mandatory) and any other parameters:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc process cfme-pv-db-example.yaml -p NFS_HOST=nfs.example.com | oc create -f -
</code></pre></div>        </div>

        <p>Alternatively, you can create the two persistent volumes and
process the templates in a single command:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc process cfme-pv-server-example.yaml -p NFS_HOST=nfs.example.com | oc create -f -
</code></pre></div>        </div>

        <div class="note">

There are three parameters required to process the template.
Only NFS\_HOST is required, PV\_SIZE and BASE\_PATH contain
defaults that do not need editing unless desired:

  - PV\_SIZE - Defaults to the recommended PV size for the
    App/DB template (5Gi/15Gi respectively)

  - BASE\_PATH - Defaults to /exports

  - NFS\_HOST - No Default - Hostname or IP address of the NFS
    server

</div>
      </li>
      <li>
        <p>Verify the persistent volumes were created successfully:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get pv
NAME                CAPACITY   ACCESSMODES   RECLAIMPOLICY   STATUS      CLAIM         STORAGECLASS   REASON    AGE
cfme-app            5Gi        RWO           Retain          Available                                          16s

cfme-db             15Gi       RWO           Retain          Available                                          49s
</code></pre></div>        </div>

        <div class="note">

Red Hat recommends validating NFS share connectivity from an
OpenShift node before attempting a deployment.

</div>
      </li>
    </ol>
  </li>
  <li>
    <p>Increase the maximum number of imported images on ImageStream.</p>

    <p>By default, OpenShift Container Platform can import five tags per
image stream, but the ManageIQ repositories contain
more than five images for deployments.</p>

    <p>You can modify this setting on the master node at
<code class="language-plaintext highlighter-rouge">/etc/origin/master/master-config.yaml</code> so OpenShift can import
additional images.</p>

    <ol>
      <li>
        <p>Add the following at the end of the
<code class="language-plaintext highlighter-rouge">/etc/origin/master/master-config.yaml</code> file:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>...
imagePolicyConfig:
  maxImagesBulkImportedPerRepository: 100
</code></pre></div>        </div>
      </li>
      <li>
        <p>Restart the master service:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ systemctl restart atomic-openshift-master
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>On each OpenShift node, persistently enable the
<code class="language-plaintext highlighter-rouge">container_manage_cgroup</code> SELinux boolean to allow container
processes to make changes to the <em>cgroup</em> configuration:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code># setsebool -P container_manage_cgroup on
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="deploying-the-manageiq-appliance">
<a class="anchor" href="#deploying-the-manageiq-appliance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploying the ManageIQ Appliance</h3>

<p>To deploy the appliance on OpenShift Container Platform, create the
ManageIQ template and verify it is available in your
project.</p>

<ol>
  <li>
    <p>As a regular user, create the ManageIQ template:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc create -f cfme-template.yaml
template "cloudforms" created
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify the template is available with your project:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get templates
NAME         DESCRIPTION                                    PARAMETERS        OBJECTS
cloudforms   CloudForms appliance with persistent storage   18 (1 blank)      12
</code></pre></div>    </div>
  </li>
  <li>
    <p>(Optional) Customize the template’s deployment parameters. Use the
following command to see the available parameters and descriptions:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc process --parameters -n &lt;your-project&gt; cloudforms
</code></pre></div>    </div>

    <p>To customize the deployment configuration parameters, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc edit dc/&lt;deployconfig_name&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>To deploy ManageIQ from template using default
settings, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc new-app --template=cloudforms
</code></pre></div>    </div>

    <p>Alternatively, to deploy ManageIQ from a template
using customized settings, add the <code class="language-plaintext highlighter-rouge">-p</code> option and the desired
parameters to the command. For example:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc new-app --template=cloudforms -p DATABASE_VOLUME_CAPACITY=2Gi,POSTGRESQL_MEM_LIMIT=4Gi,APPLICATION_DOMAIN=hostname
</code></pre></div>    </div>

    <div class="important">

The `APPLICATION_DOMAIN` parameter specifies the hostname used to
reach the ManageIQ application, which eventually
constructs the route to the ManageIQ pod. If you do
not specify the `APPLICATION_DOMAIN` parameter, the
ManageIQ application will not be accessible after the
deployment; however, this can be fixed by changing the route. For
more information on OpenShift template parameters, see the
[OpenShift Container Platform Developer
Guide](https://access.redhat.com/documentation/en-us/openshift_container_platform/3.7/html-single/developer_guide/#dev-guide-templates).

</div>
  </li>
</ol>

<h4 id="deploying-the-manageiq-appliance-using-an-external-database">
<a class="anchor" href="#deploying-the-manageiq-appliance-using-an-external-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploying the ManageIQ Appliance Using an External Database</h4>

<p>Before attempting to deploy ManageIQ using an external
database deployment, ensure the following conditions are satisfied:</p>

<ul>
  <li>
    <p>Your OpenShift cluster can access the external PostgreSQL server</p>
  </li>
  <li>
    <p>The ManageIQ user, password, and role have been
created on the external PostgreSQL server</p>
  </li>
  <li>
    <p>The intended ManageIQ database is created, and
ownership has been assigned to the ManageIQ user</p>
  </li>
</ul>

<p>To deploy the appliance:</p>

<ol>
  <li>
    <p>Import the ManageIQ external database template:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc create -f templates/cfme-template-ext-db.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Launch the deployment with the following command. The database
server IP address is required, and the other settings must match
your remote PostgreSQL server.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc new-app --template=cloudforms-ext-db -p DATABASE_IP=&lt;server_ip&gt; -p DATABASE_USER=&lt;user&gt; -p DATABASE_PASSWORD=&lt;password&gt; -p DATABASE_NAME=&lt;database_name&gt;
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="verifying-the-configuration">
<a class="anchor" href="#verifying-the-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Verifying the Configuration</h3>

<p>Verify the deployment was successful by running the following commands
as a regular user under the ManageIQ project:</p>

<div class="note">

The first deployment can take several minutes to complete while
OpenShift downloads the necessary images.

</div>

<ol>
  <li>
    <p>Confirm the ManageIQ pod is bound to the correct
security context constraints:</p>

    <ol>
      <li>
        <p>List and obtain the name of the <code class="language-plaintext highlighter-rouge">cfme-app</code> pod:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get pod
NAME                 READY     STATUS    RESTARTS   AGE
cloudforms-0         1/1       Running   0          4m
httpd-1-w486v        1/1       Running   0          4m
memcached-1-4xtjc    1/1       Running   0          4m
postgresql-1-n5tm6   1/1       Running   0          4m
</code></pre></div>        </div>
      </li>
      <li>
        <p>Export the configuration of the pod:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc export pod &lt;cfme_pod_name&gt;
</code></pre></div>        </div>
      </li>
      <li>
        <p>Examine the output to verify that <code class="language-plaintext highlighter-rouge">openshift.io/scc</code> has the
value <code class="language-plaintext highlighter-rouge">anyuid</code>:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>...
metadata:
  annotations:
    openshift.io/scc: anyuid
...
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>
    <p>Verify the persistent volumes are attached to the <code class="language-plaintext highlighter-rouge">postgresql</code> and
<code class="language-plaintext highlighter-rouge">cfme-app</code> pods:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc volume pods --all
pods/postgresql-1-437jg
  pvc/cfme-pgdb-claim (allocated 2GiB) as cfme-pgdb-volume
    mounted at /var/lib/pgsql/data
  secret/default-token-2se06 as default-token-2se06
    mounted at /var/run/secrets/kubernetes.io/serviceaccount
pods/cfme-1-s3bnp
  pvc/cfme (allocated 2GiB) as cfme-app-volume
    mounted at /persistent
  secret/default-token-9q4ge as default-token-9q4ge
    mounted at /var/run/secrets/kubernetes.io/serviceaccount
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check the readiness of the ManageIQ pod:</p>

    <div class="note">

Allow approximately five minutes once pods are in running state for
ManageIQ to start responding on HTTPS.

</div>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc describe pods &lt;cfme_pod_name&gt;
...
Conditions:
  Type      Status
  Ready     True
Volumes:
...
</code></pre></div>    </div>
  </li>
  <li>
    <p>After you have successfully validated your ManageIQ
deployment, disable automatic image change triggers to prevent
unintended upgrades.</p>

    <p>By default, on initial deployments the automatic image change
trigger is enabled. This could potentially start an unintended
upgrade on a deployment if a newer image is found in the
ImageStream.</p>

    <p>Disable the automatic image change triggers for
ManageIQ deployment configurations (DCs) on each
project with the following commands:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc set triggers dc --manual -l app=cloudforms
deploymentconfig "memcached" updated
deploymentconfig "postgresql" updated

$ oc set triggers dc --from-config --auto -l app=cloudforms
deploymentconfig "memcached" updated
deploymentconfig "postgresql" updated
</code></pre></div>    </div>

    <div class="note">

The configuration change trigger is kept enabled; to have full
control of your deployments, you can alternatively turn it off. See
the [OpenShift Container Platform Developer
Guide](https://access.redhat.com/documentation/en-us/openshift_container_platform/3.7/html-single/developer_guide/#dev-guide-triggering-builds)
for more information on deployment triggers.

</div>
  </li>
</ol>

<h3 id="logging-into-manageiq">
<a class="anchor" href="#logging-into-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Logging into ManageIQ</h3>

<p>As part of the deployment, a route to the ManageIQ
appliance is created for HTTPS access. Once the pods have been
successfully deployed, you can log into ManageIQ.</p>

<p>You can obtain the ManageIQ host address from the project
in the OpenShift user interface, or by opening a shell on the pod and
getting the route information.</p>

<ol>
  <li>
    <p>To open a shell on the pod, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc rsh &lt;pod_name&gt; bash -l
</code></pre></div>    </div>
  </li>
  <li>
    <p>Get the route information:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get routes
NAME         HOST/PORT                   PATH                SERVICE      TERMINATION   LABELS
cloudforms   cfme.apps.e2e.example.com  cloudforms:443-tcp   passthrough                app=cloudforms
</code></pre></div>    </div>
  </li>
  <li>
    <p>Navigate to the reported URL/host on a web browser (in this example,
<code class="language-plaintext highlighter-rouge">cfme.apps.e2e.example.com</code>).</p>
  </li>
  <li>
    <p>Enter the default ManageIQ credentials (Username:
<strong>admin</strong> | Password: <strong>smartvm</strong>) for the initial login.</p>
  </li>
  <li>
    <p>Click <strong>Login</strong>.</p>
  </li>
</ol>

<h2 id="configuring-external-authentication-to-manageiq">
<a class="anchor" href="#configuring-external-authentication-to-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring External Authentication to ManageIQ</h2>

<p>After installing ManageIQ, configure external authentication by updating the <code class="language-plaintext highlighter-rouge">httpd-auth-configs</code> configuration map on the <code class="language-plaintext highlighter-rouge">httpd</code> pod to include all necessary configuration files and certificates.</p>

<p>Upon startup, the <code class="language-plaintext highlighter-rouge">httpd</code> pod overlays its files with the ones specified in the <code class="language-plaintext highlighter-rouge">auth-configuration.conf</code> file in the configuration map. This is done by the <code class="language-plaintext highlighter-rouge">initialize-httpd-auth</code> service that runs before <code class="language-plaintext highlighter-rouge">httpd</code>.</p>

<p>You can automatically generate an updated configuration map by running the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> tool in its own pod using the steps in <a href="#automatic-defining-configmap">Configuring External Authentication Automatically</a> (recommended).
Alternatively, you can define the configuration map manually using the commands in <a href="#manually-defining-configmap">Defining the Configuration Map Manually</a>.</p>

<h3 id="configuring-external-authentication-automatically">
<a class="anchor" href="#configuring-external-authentication-automatically" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring External Authentication Automatically</h3>

<p>To automatically generate an <code class="language-plaintext highlighter-rouge">authconfig</code> map, run the <code class="language-plaintext highlighter-rouge">httpd_configmap_generator</code> tool with your desired parameters:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator &lt;command_or_authentication_type&gt;
</code></pre></div></div>

<p><strong>Note:</strong></p>

<p>Run <code class="language-plaintext highlighter-rouge">httpd_configmap_generator --help</code> or see <a href="#configmap-settings">External Authentication Configuration Map Settings</a>
for configuration map parameters.</p>

<h4 id="supported-authentication-types">
<a class="anchor" href="#supported-authentication-types" aria-hidden="true"><span class="octicon octicon-link"></span></a>Supported Authentication Types</h4>

<p>The following authentication types can be configured with the <code class="language-plaintext highlighter-rouge">httpd_configmap_generator</code> tool to configure external authentication.</p>

<p>For usage, run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator &lt;auth-type&gt; --help
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>auth-type</td>
      <td>Identity Provider/Environment</td>
    </tr>
    <tr>
      <td>active-directory</td>
      <td>Active Directory domain realm join</td>
    </tr>
    <tr>
      <td>ipa</td>
      <td>IPA, IPA 2-factor authentication, IPA/AD Trust</td>
    </tr>
    <tr>
      <td>ldap</td>
      <td>LDAP directories</td>
    </tr>
    <tr>
      <td>saml</td>
      <td>Keycloak, Red Hat SSO</td>
    </tr>
  </tbody>
</table>

<p>Supported Authentication Types</p>

<h4 id="updating-an-authconfig-map">
<a class="anchor" href="#updating-an-authconfig-map" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating an <code class="language-plaintext highlighter-rouge">authconfig</code> Map</h4>

<p>With the <code class="language-plaintext highlighter-rouge">update</code> subcommand, you can add file(s) to the configuration map to specify file ownership and permissions. The <code class="language-plaintext highlighter-rouge">--add-file</code> option can be specified multiple times (once per file) to add files to a configuration map.</p>

<p>Supported file specifications for the <code class="language-plaintext highlighter-rouge">--add-file</code> option are:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--add-file=file-path
--add-file=source-file-path,target-file-path
--add-file=source-file-path,target-file-path,file-permission
--add-file=file-url,target-file-path,file-permission
</code></pre></div></div>

<p>When entering file specifications, <code class="language-plaintext highlighter-rouge">file-url</code> is an HTTP URL and <code class="language-plaintext highlighter-rouge">file-permission</code> can be specified as <code class="language-plaintext highlighter-rouge">mode:owner:group</code>.</p>

<p><strong>Adding files by specifying paths.</strong></p>

<p>The file ownership and permissions are based on the files specified. For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator update \
--input=/tmp/original-auth-configmap.yaml                \
--add-file=/etc/openldap/cacerts/primary-directory-cert.pem  \
--add-file=/etc/openldap/cacerts/seconday-directory-cert.pem \
--output=/tmp/updated-auth-configmap.yaml
</code></pre></div></div>

<p><strong>Adding target files from different source directories.</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator update \
--input=/tmp/original-auth-configmap.yaml                                        \
--add-file=/tmp/uploaded-cert1,/etc/openldap/cacerts/primary-directory-cert.pem  \
--add-file=/tmp/uploaded-cert2,/etc/openldap/cacerts/seconday-directory-cert.pem \
--output=/tmp/updated-auth-configmap.yaml
</code></pre></div></div>

<p>The file ownership and permissions are based on the source files specified; in this case the ownership and permissions of the
<code class="language-plaintext highlighter-rouge">/tmp/uploaded-cert1</code> and <code class="language-plaintext highlighter-rouge">/tmp/uploaded-cert2</code> files will be used.</p>

<p><strong>Adding a target file with user-specified ownership and mode.</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator update \
--input=/tmp/original-auth-configmap.yaml                          \
--add-file=/tmp/secondary-keytab,/etc/http2.keytab,600:apache:root \
--output=/tmp/updated-auth-configmap.yaml
</code></pre></div></div>

<p><strong>Adding files by URL.</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator update \
--input=/tmp/original-auth-configmap.yaml \
--add-file=http://aab-keycloak:8080/auth/realms/testrealm/protocol/saml/description,/etc/httpd/saml2/idp-metadata.xml,644:root:root \
--output=/tmp/updated-auth-configmap.yaml
</code></pre></div></div>

<p>When downloading a file by URL, a target file path and file ownership and mode must be specified.</p>

<h4 id="exporting-a-file-from-an-authconfig-map">
<a class="anchor" href="#exporting-a-file-from-an-authconfig-map" aria-hidden="true"><span class="octicon octicon-link"></span></a>Exporting a File from an <code class="language-plaintext highlighter-rouge">authconfig</code> Map</h4>

<p>With the <code class="language-plaintext highlighter-rouge">export</code> subcommand, you can export a file from the configuration map. For example, to extract the <code class="language-plaintext highlighter-rouge">sssd.conf</code> file from the <code class="language-plaintext highlighter-rouge">authconfig</code> map:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ httpd_configmap_generator export \
--input=/tmp/external-ipa.yaml \
--file=/etc/sssd/sssd.conf     \
--output=/tmp/sssd.conf
</code></pre></div></div>

<h4 id="building-the-httpd_configmap_generator-in-a-container">
<a class="anchor" href="#building-the-httpd_configmap_generator-in-a-container" aria-hidden="true"><span class="octicon octicon-link"></span></a>Building the <code class="language-plaintext highlighter-rouge">httpd_configmap_generator</code> in a Container</h4>

<p>The <code class="language-plaintext highlighter-rouge">httpd_configmap_generator</code> is the container for configuring external authentication for the <code class="language-plaintext highlighter-rouge">httpd</code> auth pod. It is based on the auth <code class="language-plaintext highlighter-rouge">httpd</code> container and generates the <code class="language-plaintext highlighter-rouge">httpd</code> <code class="language-plaintext highlighter-rouge">authconfig</code> map needed to enable external authentication.</p>

<p>Two templates are required to run the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> application (<code class="language-plaintext highlighter-rouge">httpd-configmap-generator-htmplate.yaml</code> and <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin.yaml</code>), which are available from the <a href="https://access.redhat.com/containers/?tab=images&amp;platform=openshift#/registry.access.redhat.com/cloudforms46/cfme-httpd-configmap-generator">Red Hat Container Catalog</a>.</p>

<h5 id="preparing-to-deploy-the-httpd-configmap-generator-application">
<a class="anchor" href="#preparing-to-deploy-the-httpd-configmap-generator-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Preparing to Deploy the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> Application</h5>

<ol>
  <li>
    <p>To obtain the latest <code class="language-plaintext highlighter-rouge">cfme-httpd-configmap-generator</code> image from the Red Hat Container Catalog, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc import-image my-cloudforms46/cfme-httpd-configmap-generator --from=registry.access.redhat.com/cloudforms46/cfme-httpd-configmap-generator --confirm
</code></pre></div>    </div>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> service account must be added to the <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin</code> security context constraints (SCC) before the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> can run. To edit the SCC, log in to OpenShift as an admin user:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc login -u &lt;user&gt; -p &lt;password&gt;
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create the <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin</code> SCC:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc create -f templates/httpd-scc-sysadmin.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> service account to the <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin</code> SCC:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc adm policy add-scc-to-user httpd-scc-sysadmin system:serviceaccount:&lt;your-namespace&gt;:httpd-configmap-generator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify that the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> service account is now included in the <code class="language-plaintext highlighter-rouge">httpd-scc-sysadmin</code> SCC:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc describe scc httpd-scc-sysadmin | grep Users
Users:        system:serviceaccount:&lt;your-namespace&gt;:httpd-configmap-generator
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="deploying-the-httpd-configmap-generator-application">
<a class="anchor" href="#deploying-the-httpd-configmap-generator-application" aria-hidden="true"><span class="octicon octicon-link"></span></a>Deploying the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> Application</h5>

<ol>
  <li>
    <p>As a regular user, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc create -f httpd-configmap-generator-template.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify the template is available with your project:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get templates
NAME                        DESCRIPTION                                 PARAMETERS     OBJECTS
httpd-configmap-generator   Httpd Configmap Generator                   6 (all set)    3
</code></pre></div>    </div>
  </li>
  <li>
    <p>Deploy the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code>:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc new-app --template=httpd-configmap-generator
</code></pre></div>    </div>
  </li>
  <li>
    <p>Check the readiness of the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code>:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get pods
NAME                                READY     STATUS    RESTARTS   AGE
httpd-configmap-generator-1-txc34   1/1       Running   0          1h
</code></pre></div>    </div>
  </li>
</ol>

<h5 id="getting-the-pod-name">
<a class="anchor" href="#getting-the-pod-name" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting the Pod Name</h5>

<p>To work with the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> script in the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> pod, it is necessary to get the pod name as
follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ CONFIGMAP_GENERATOR_POD=`oc get pods | grep "httpd-configmap-generator" | cut -f1 -d" "`
</code></pre></div></div>

<h5 id="example-generating-an-authconfig-map-for-external-authentication-against-ipa">
<a class="anchor" href="#example-generating-an-authconfig-map-for-external-authentication-against-ipa" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example: Generating an <code class="language-plaintext highlighter-rouge">authconfig</code> Map for External Authentication Against IPA</h5>

<p>The following example shows how to generate a configuration map for external authentication using IPA.</p>

<ol>
  <li>
    <p>To generate an <code class="language-plaintext highlighter-rouge">authconfig</code> map for external authentication using IPA, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc rsh $CONFIGMAP_GENERATOR_POD -- bash -c httpd_configmap_generator ipa \
--host=appliance.example.com        \
--ipa-server=ipaserver.example.com  \
--ipa-domain=example.com            \
--ipa-realm=EXAMPLE.COM             \
--ipa-principal=admin               \
--ipa-password=smartvm1             \
-o /tmp/external-ipa.yaml
</code></pre></div>    </div>

    <p><strong>Note:</strong></p>

    <p><code class="language-plaintext highlighter-rouge">--host</code> must be the DNS of the application exposing the <code class="language-plaintext highlighter-rouge">httpd</code> pod, for example ${APPLICATION_DOMAIN}.</p>
  </li>
  <li>
    <p>Copy the new <code class="language-plaintext highlighter-rouge">authconfig</code> map back locally:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc cp $CONFIGMAP_GENERATOR_POD:/tmp/external-ipa.yaml ./external-ipa.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Apply the new configuration map to the <code class="language-plaintext highlighter-rouge">httpd</code> pod, and then redeploy it to take effect:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc replace configmaps httpd-auth-configs --filename ./external-ipa.yaml
</code></pre></div>    </div>
  </li>
</ol>

<p>To generate a new <code class="language-plaintext highlighter-rouge">authconfig</code> map, redeploy the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> pod first to get a clean environment before
running the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> tool.</p>

<p>If additional configuration is needed, you can configure the configuration map manually using the steps in <a href="#manually-defining-configmap">Defining the
Configuration Map Manually</a>. See <a href="#configmap-settings">External Authentication Configuration Map Settings</a> for configuration map parameters.</p>

<h5 id="cleaning-up">
<a class="anchor" href="#cleaning-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cleaning up</h5>

<p>After generating an <code class="language-plaintext highlighter-rouge">authconfig</code> map, the <code class="language-plaintext highlighter-rouge">httpd-configmap-generator</code> pod can be scaled down, or deleted if no longer needed.</p>

<p>To scale down the pod, run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ oc scale dc httpd-configmap-generator --replicas=0
</code></pre></div></div>

<p>To delete the pod, run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ oc delete all  -l app=httpd-configmap-generator
$ oc delete pods -l app=httpd-configmap-generator
</code></pre></div></div>

<h3 id="defining-the-configuration-map-manually">
<a class="anchor" href="#defining-the-configuration-map-manually" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining the Configuration Map Manually</h3>

<p>The <code class="language-plaintext highlighter-rouge">authconfig</code> map can be defined and customized in the <code class="language-plaintext highlighter-rouge">httpd</code> pod as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ oc edit configmaps httpd-auth-configs
</code></pre></div></div>

<p>Alternatively, you can replace the <code class="language-plaintext highlighter-rouge">httpd-auth-configs</code> file with an externally generated and edited configuration file as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ oc replace configmaps httpd-auth-configs --filename external-auth-configmap.yaml
</code></pre></div></div>

<p>After editing the configuration map, redeploy the <code class="language-plaintext highlighter-rouge">httpd</code> pod for the new authentication configuration to take effect.</p>

<h2 id="managing-manageiq-with-openshift">
<a class="anchor" href="#managing-manageiq-with-openshift" aria-hidden="true"><span class="octicon octicon-link"></span></a>Managing ManageIQ with OpenShift</h2>

<p>This section includes common tasks to manage your ManageIQ deployment from OpenShift.</p>

<h3 id="configuring-custom-ssl-certificates-for-manageiq">
<a class="anchor" href="#configuring-custom-ssl-certificates-for-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring Custom SSL Certificates for ManageIQ</h3>

<p>By default, the route that is deployed as part of the template uses edge termination and the certificates that OpenShift is installed with. It is possible to change this in the OpenShift UI with the following steps:</p>

<ol>
  <li>
    <p>Browse to menu: <strong>Applications &gt; Routes</strong>.</p>
  </li>
  <li>
    <p>Click on the route named <strong>httpd</strong>, then select menu: <strong>Actions &gt; Edit</strong>.</p>
  </li>
  <li>
    <p>Scroll down to the <strong>Certificates</strong> section. Here you can upload or paste the required certificate files.</p>
  </li>
  <li>
    <p>Click <strong>Save</strong>.</p>
  </li>
</ol>

<h3 id="scaling-manageiq-appliances">
<a class="anchor" href="#scaling-manageiq-appliances" aria-hidden="true"><span class="octicon octicon-link"></span></a>Scaling ManageIQ Appliances</h3>

<p>StatefulSets in OpenShift manage the deployment and scaling of a set of pods (in this case, ManageIQ appliances). StatefulSets ensure ordering that applications will come up by providing unique identities for pods.</p>

<p><strong>Important:</strong></p>

<p>Each new replica (server) consumes a physical volume. Before scaling, ensure you have enough physical volumes available to scale.</p>

<p>The following example shows scaling using StatefulSets:</p>

<p><strong>Example: Scaling to two replicas.</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ oc scale statefulset cloudforms --replicas=2
statefulset "cloudforms" scaled
$ oc get pods
NAME                 READY     STATUS    RESTARTS   AGE
cloudforms-0           1/1       Running   0          34m
cloudforms-1           1/1       Running   0          5m
memcached-1-mzeer    1/1       Running   0          1h
postgresql-1-dufgp   1/1       Running   0          1h
</code></pre></div></div>

<p>The newly created replicas will join the existing ManageIQ region. Each new pod is numbered in the order it is deployed, starting with 0 and increasing sequentially. For example, replicas in a StatefulSet will be numbered <em>cloudforms-0</em> <em>cloudforms-1</em>, and so on.</p>

<h3 id="creating-a-backup">
<a class="anchor" href="#creating-a-backup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a Backup</h3>

<p>Create a persistent volume for backups using the PV backup template (<code class="language-plaintext highlighter-rouge">cfme-pv-backup-example.yaml</code>) in case you need to restore to a previous version.</p>

<ol>
  <li>
    <p>Create the persistent volume for the backup:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f cfme-pv-backup-example.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create the backup persistent volume claim (PVC):</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f cfme-backup-pvc.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Verify the persistent volume claim was created:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc get pvc
</code></pre></div>    </div>
  </li>
  <li>
    <p>Back up secrets, such as database encryption keys and credentials.</p>

    <p><strong>Important:</strong></p>

    <p>Be careful to back up secrets in a secure location.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc get secret -o yaml --export=true &gt; secrets.yaml
 $ oc get pvc -o yaml --export=true &gt; pvc.yaml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Initiate the database backup:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f cfme-backup-job.yaml
</code></pre></div>    </div>
  </li>
</ol>

<p>This step creates a container, and connects to the database pod, <code class="language-plaintext highlighter-rouge">pg_basebackup</code>.</p>

<h3 id="restoring-to-a-backup">
<a class="anchor" href="#restoring-to-a-backup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Restoring to a Backup</h3>

<p>You can restore to a database backup created in <a href="#creating-backups">Creating a Backup</a> using the restore template,
<code class="language-plaintext highlighter-rouge">cfme-restore-job.yaml</code>.</p>

<p>The restore job will look for <code class="language-plaintext highlighter-rouge">cfme-backup</code> and <code class="language-plaintext highlighter-rouge">cfme-postgresql</code> PVs by default, and the latest successful backup will be restored by default. If existing data is found on the <code class="language-plaintext highlighter-rouge">cfme-postgresql</code> volume, it will be renamed and left on the volume.</p>

<p><strong>Important:</strong></p>

<p>You must perform a database restore on an offline environment. All pods must be scaled down to 0, and not running.</p>

<ol>
  <li>
    <p>Shut down all pods:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc scale dc --all --replicas=0
 $ oc scale statefulset --all --replicas=0
</code></pre></div>    </div>
  </li>
  <li>
    <p>To initiate the database restore, create the restore template:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc create -f cfme-restore-job.yaml
</code></pre></div>    </div>
  </li>
</ol>

<p>After the restore job is complete, you can scale the pods back up.</p>

<h3 id="updating-manageiq">
<a class="anchor" href="#updating-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating ManageIQ</h3>

<p>Apply package updates to your ManageIQ appliance from OpenShift Container Platform by deleting the pods and redeploying them using updated ManageIQ container images. To update your environment with a new template, follow the steps in <a href="#modified-template-update">Updating the ManageIQ Container Images and Template</a>.</p>

<h4 id="updating-the-manageiq-container-images">
<a class="anchor" href="#updating-the-manageiq-container-images" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating the ManageIQ Container Images</h4>

<p>To deploy new container images for ManageIQ, delete the pods, update the images, then redeploy the updated pods:</p>

<ol>
  <li>
    <p>Delete the pods by scaling the application StatefulSets to 0 replicas:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc scale statefulset cloudforms --replicas=0
 $ oc scale statefulset cloudforms-backend --replicas=0
</code></pre></div>    </div>
  </li>
  <li>
    <p>Patch in the new version of the images:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc patch statefulset cloudforms -p '{"spec": {"template": {"spec": {"containers": [{"name": "cloudforms", "image": "registry.redhat.io/cloudforms46/cfme-openshift-app-ui:&lt;new-version-tag&gt;"}]}}}}'
 $ oc patch statefulset cloudforms-backend -p '{"spec": {"template": {"spec": {"containers": [{"name": "cloudforms", "image": "registry.redhat.io/cloudforms46/cfme-openshift-app:&lt;new-version-tag&gt;"}]}}}}'
</code></pre></div>    </div>
  </li>
  <li>
    <p>Scale the StatefulSets back to your previous values to redeploy the pods:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc scale statefulset cloudforms --replicas=&lt;old-value&gt;
 $ oc scale statefulset cloudforms-backend --replicas=&lt;old-value&gt;
</code></pre></div>    </div>
  </li>
</ol>

<p>Your ManageIQ environment is now updated to use the new container images.</p>

<h4 id="updating-the-manageiq-container-images-and-template">
<a class="anchor" href="#updating-the-manageiq-container-images-and-template" aria-hidden="true"><span class="octicon octicon-link"></span></a>Updating the ManageIQ Container Images and Template</h4>

<p>To update a ManageIQ deployment with a new template, update the container images and the template using the following steps:</p>

<ol>
  <li>
    <p>Back up secrets, such as database encryption keys and credentials:</p>

    <p><strong>Important:</strong></p>

    <p>Be careful to back up secrets in a secure location.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc export secret cloudforms-secrets &gt; my_secrets.yml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Delete the pods by scaling the application StatefulSets to 0 replicas:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc scale statefulset cloudforms --replicas=0
 $ oc scale statefulset cloudforms-backend --replicas=0
</code></pre></div>    </div>
  </li>
  <li>
    <p>Apply the changes to the project, specifying the template appropriate to your environment’s database configuration.</p>

    <p><strong>Important:</strong></p>

    <p>If you customized any parameters when originally deploying the application (parameters used with the <code class="language-plaintext highlighter-rouge">oc new-app</code> command in <a href="#deploying-the-appliance">Deploying the ManageIQ Appliance</a>), you must set the same values in the <code class="language-plaintext highlighter-rouge">oc process</code> command here.</p>

    <ul>
      <li>
        <p>For environments using a database stored on a pod within the cluster (the default configuration), specify the
ManageIQ template:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc process -p APPLICATION_REPLICA_COUNT=0 -l app=cloudforms,template=cloudforms -f cfme-template.yaml | oc replace -f -
</code></pre></div>        </div>
      </li>
      <li>
        <p>For environments using a database external to the OpenShift cluster, specify the ManageIQ external database template:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc process -p APPLICATION_REPLICA_COUNT=0 -l app=cloudforms,template=cloudforms-ext-db -f cfme-template-ext-db.yaml | oc replace -f -
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>
    <p>Replace the secret with the <code class="language-plaintext highlighter-rouge">my_secrets.yml</code> file you created earlier:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc replace -f my_secrets.yml
</code></pre></div>    </div>
  </li>
  <li>
    <p>Redeploy the <code class="language-plaintext highlighter-rouge">postgresql</code> pod to ensure the password from the old secret is used:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc rollout latest postgresql
</code></pre></div>    </div>
  </li>
  <li>
    <p>Scale the StatefulSets back to your previous values to redeploy the pods:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc scale statefulset cloudforms --replicas=&lt;old-value&gt;
$ oc scale statefulset cloudforms-backend --replicas=&lt;old-value&gt;
</code></pre></div>    </div>
  </li>
</ol>

<p>Your ManageIQ environment is now updated to use the new template and container images.</p>

<h3 id="uninstalling-manageiq-from-a-project">
<a class="anchor" href="#uninstalling-manageiq-from-a-project" aria-hidden="true"><span class="octicon octicon-link"></span></a>Uninstalling ManageIQ from a Project</h3>

<p>If no longer needed, you can uninstall the ManageIQ pod from your project. Note the following commands do not remove SCC permissions, or the project itself.</p>

<p><strong>Important:</strong></p>

<p>Use this procedure if only ManageIQ exists in the project.</p>

<ol>
  <li>
    <p>Inside the project, run the following as a regular user:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc delete all --all
</code></pre></div>    </div>
  </li>
  <li>
    <p>Wait approximately 30 seconds for the command to process, then run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> $ oc delete pvc --all
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="troubleshooting-deployment">
<a class="anchor" href="#troubleshooting-deployment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Troubleshooting Deployment</h2>

<p>Under normal circumstances, the deployment process takes approximately
10 minutes. If the deployment is unsuccessful, examining deployment
events and pod logs can help identify any issues.</p>

<ol>
  <li>
    <p>As a regular user, first retry the failed deployment:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc get pods
NAME                 READY     STATUS    RESTARTS   AGE
cloudforms-1-deploy  0/1       Error     0          25m
memcached-1-yasfq    1/1       Running   0          24m
postgresql-1-wfv59   1/1       Running   0          24m

$ oc deploy cloudforms --retry
Retried #1
Use 'oc logs -f dc/cloudforms' to track its progress.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Allow a few seconds for the failed pod to get re-scheduled, then
check events and logs:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc describe pods &lt;pod-name&gt;
...
Events:
  FirstSeen LastSeen    Count   From                            SubobjectPath           Type        Reason      Message
  --------- --------    -----   ----                            -------------           --------    ------      -------
15m     15m     1   {kubelet ocp-eval-node-2.e2e.example.com}   spec.containers{cloudforms} Warning     Unhealthy   Readiness probe failed: Get http://10.1.1.5:80/: dial tcp 10.1.1.5:80: getsockopt: connection refused
</code></pre></div>    </div>

    <p>Liveness and readiness probe failures, like in the output above,
indicate the pod is taking longer than expected to come online. In
this case, check the pod logs.</p>
  </li>
  <li>
    <p>As the <code class="language-plaintext highlighter-rouge">cfme-app</code> container is <code class="language-plaintext highlighter-rouge">systemd</code> based, use <code class="language-plaintext highlighter-rouge">oc rsh</code> instead
of <code class="language-plaintext highlighter-rouge">oc logs</code> to obtain journal dumps:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc rsh &lt;pod-name&gt; journalctl -x
</code></pre></div>    </div>
  </li>
  <li>
    <p>Transferring all logs from the <code class="language-plaintext highlighter-rouge">cfme-app</code> pod to a directory on the
host for further examination can be useful for troubleshooting.
Transfer the logs with the <code class="language-plaintext highlighter-rouge">oc rsync</code> command:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>$ oc rsync &lt;pod-name&gt;:/persistent/container-deploy/log \
/tmp/fail-logs/
receiving incremental file list
log/
log/appliance_initialize_1477272109.log
log/restore_pv_data_1477272010.log
log/sync_pv_data_1477272010.log

sent 72 bytes  received 1881 bytes  1302.00 bytes/sec
total size is 1585  speedup is 0.81
</code></pre></div>    </div>
  </li>
</ol>

<h2 id="appendix">
<a class="anchor" href="#appendix" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appendix</h2>

<h3 id="external-authentication-configuration-map-settings">
<a class="anchor" href="#external-authentication-configuration-map-settings" aria-hidden="true"><span class="octicon octicon-link"></span></a>External Authentication Configuration Map Settings</h3>

<p>See <a href="#appe-saml-authentication-example">Sample External Authentication
Configuration</a> for an example
configuration map file.</p>

<p>The configuration map includes the following parameters:</p>

<ul>
  <li>
    <p>auth-type
The authentication type.</p>

    <p>This parameter controls which configuration files <code class="language-plaintext highlighter-rouge">httpd</code> will load
upon startup. The default is <code class="language-plaintext highlighter-rouge">internal</code>. Supported values are:</p>

    <table>
      <thead>
        <tr>
          <th>Value</th>
          <th>External Authentication Configuration</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">internal</code></td>
          <td>Application Based Authentication - Database, LDAP/LDAPS, Amazon. This is the default.</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">external</code></td>
          <td>IPA, IPA 2-factor authentication, IPA/AD Trust, LDAP (OpenLDAP, RHDS, Active Directory, etc.)</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">active-directory</code></td>
          <td>Active Directory domain realm join</td>
        </tr>
        <tr>
          <td><code class="language-plaintext highlighter-rouge">saml</code></td>
          <td>SAML based authentication (Keycloak, ADFS, etc.)</td>
        </tr>
      </tbody>
    </table>

    <p><code class="language-plaintext highlighter-rouge">auth-type</code> values</p>

    <div class="important">

Enabling external authentication must be done from the
ManageIQ user interface; see [Configuring External
Authentication](https://access.redhat.com/documentation/en-us/red_hat_cloudforms/4.7/html/managing_authentication_for_cloudforms/external_auth)
in *Managing Authentication* for details.

</div>
  </li>
  <li>
    <p>auth-kerberos-realms
The Kerberos realms to join.</p>

    <p>When configuring external authentication against IPA, Active
Directory or LDAP, this parameter defines the Kerberos realm <code class="language-plaintext highlighter-rouge">httpd</code>
is configured against, such as <em>example.com</em>. When specifying
multiple Kerberos realms, they must be separated by spaces. The
default is <code class="language-plaintext highlighter-rouge">undefined</code>.</p>
  </li>
  <li>
    <p>auth-configuration.conf
The external authentication configuration file which declares the
list of files to overlay upon startup if <code class="language-plaintext highlighter-rouge">auth-type</code> is other than
<code class="language-plaintext highlighter-rouge">internal</code>.</p>

    <p>Syntax for the file is as follows:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code># for comments
file = basename1 target_path1 permission1
file = basename2 target_path2 permission2
</code></pre></div>    </div>

    <p>For the files to overlay on the <code class="language-plaintext highlighter-rouge">httpd</code> pod, one <code class="language-plaintext highlighter-rouge">file</code> directive is
needed per file.</p>
  </li>
  <li>
    <p>basename
The name of the source file in the configuration map.</p>
  </li>
  <li>
    <p>permission
(optional) By default, files are copied using the pod’s default
umask, owner and group, so files are created as mode 644 owner root,
group root.</p>

    <p><code class="language-plaintext highlighter-rouge">permission</code> can be specified as follows, reflecting the mode and
ownership to set the copied files to:</p>

    <ul>
      <li>
        <p>mode</p>
      </li>
      <li>
        <p>mode:owner</p>
      </li>
      <li>
        <p>mode:owner:group</p>

        <p>For example:</p>
      </li>
      <li>
        <p>755</p>
      </li>
      <li>
        <p>640:root</p>
      </li>
      <li>
        <p>644:root:apache</p>

        <p>Binary files can be specified in the configuration map in their
base64 encoded format with a basename having a <code class="language-plaintext highlighter-rouge">.base64</code>
extension. Such files are then converted back to binary as they
are copied to their target path.</p>

        <p>When an <code class="language-plaintext highlighter-rouge">/etc/sssd/sssd.conf</code> file is included in the
configuration map, the <code class="language-plaintext highlighter-rouge">httpd</code> pod automatically enables the
SSSD service upon startup.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>target_path
The path of the file on the pod to overwrite, i.e.
<code class="language-plaintext highlighter-rouge">/etc/sssd/sssd.conf</code>.</p>
  </li>
</ul>

<h3 id="sample-external-authentication-configuration">
<a class="anchor" href="#sample-external-authentication-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sample External Authentication Configuration</h3>

<p>The following is an example of the data section of a SAML auth-config
map data section (excluding the content of the files):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
data:
auth-type: saml
auth-kerberos-realms: example.com
auth-configuration.conf: |
<span class="c">#</span>
<span class="c"># Configuration for SAML authentication</span>
<span class="c">#</span>
file <span class="o">=</span> manageiq-remote-user.conf        /etc/httpd /conf.d/manageiq-remote-user.conf        644
file <span class="o">=</span> manageiq-external-auth-saml.conf /etc/httpd/conf.d/manageiq-external-auth-saml.conf 644
file <span class="o">=</span> idp-metadata.xml                 /etc/httpd/saml2/idp-metadata.xml                  644
file <span class="o">=</span> sp-key.key                       /etc/httpd/saml2/sp-key.key                        600:root:root
file <span class="o">=</span> sp-cert.cert                     /etc/httpd/saml2/sp-cert.cert                      644
file <span class="o">=</span> sp-metadata.xml                  /etc/httpd/saml2/sp-metadata.xml                   644
manageiq-remote-user.conf: |
RequestHeader <span class="nb">unset </span>X_REMOTE_USER
...
manageiq-external-auth-saml.conf: |
LoadModule auth_mellon_module modules/mod_auth_mellon.so
...
idp-metadata.xml: |
&lt;EntitiesDescriptor ...
...
&lt;/EntitiesDescriptor&gt;
sp-key.key: |
<span class="nt">-----BEGIN</span> PRIVATE KEY-----
...
<span class="nt">-----END</span> PRIVATE KEY-----
sp-cert.cert: |
<span class="nt">-----BEGIN</span> CERTIFICATE-----
...
<span class="nt">-----END</span> CERTIFICATE-----
sp-metadata.xml: |
&lt;EntityDescriptor ...
...
&lt;/EntityDescriptor&gt;
</code></pre></div></div>



      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2023 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
