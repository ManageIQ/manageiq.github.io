<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <link type="text/css" rel="stylesheet" href="/assets/main-449f300b687d04a2e9dcdb8c4a6e66dbed7703969a9b64f3f189cef381afd146.css">
  <link rel="canonical" href="http://manageiq.org/docs/reference/latest/appliance_hardening_guide/">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/reference/kasparov/appliance_hardening_guide/index">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li class="active">
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li>
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<div class="doc_menu-heading">
  Kasparov
</div>

<ul class="menu menu-toplevel" id=ref_menu_kasparov>


  <li class="menu-parent">
    
    <a href="#">
      Installation
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_aws/index.html">
      Amazon Web Services (AWS)
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_kubernetes/index.html">
      Kubernetes
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_ibm_cloud/index.html">
      IBM Cloud
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_microsoft_azure/index.html">
      Microsoft Azure
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_google_compute_engine/index.html">
      Google Compute Engine
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_vmware_vsphere/index.html">
      VMware vSphere
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_red_hat_enterprise_linux_openstack_platform/index.html">
      Red Hat Enterprise OpenStack Platform
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_red_hat_virtualization/index.html">
      Red Hat Enterprise Virtualization
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/installing_on_scvmm/index.html">
      Microsoft System Center Virtual Machine Manager (SCVMM)
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Configuration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/deployment_planning_guide/index.html">
      Deployment Planning Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/general_configuration/index.html">
      General Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/high_availability_guide/index.html">
      High Availability Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item active">
    <a href="/docs/reference/kasparov/appliance_hardening_guide/index.html">
      Appliance Hardening Guide
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Administration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/monitoring_alerts_and_reporting/index.html">
      Monitoring, Alerts, and Reporting
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/policies_and_profiles_guide/index.html">
      Policies and Profiles Guide
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/managing_infrastructure_and_inventory/index.html">
      Managing Infrastructure and Inventory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/managing_providers/index.html">
      Managing Providers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/provisioning_virtual_machines_and_hosts/index.html">
      Provisioning Virtual Machines and Hosts
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/scripting_actions/index.html">
      Scripting Actions in ManageIQ
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Authentication
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/active_directory.html">
      Active Directory
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/ipa_2fa.html">
      2-Factor-Authentication with IPA
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/ipa_ad_trust.html">
      IPA/AD Trust
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/ldap.html">
      LDAP
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/saml.html">
      SAML
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/auth/openid_connect.html">
      OpenID-Connect
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Integration
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/integration_with_aws_cloudformation_and_openstack_heat/index.html">
      AWS CloudFormation and OpenStack Heat
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/integration_with_servicenow/index.html">
      ServiceNow
    </a>
    
  </li>


      </ul>
    
  </li>


  <li class="menu-parent">
    
    <a href="#">
      Reference
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/capabilities_matrix/index.html">
      Capabilities Matrix
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/rest_api/index.html">
      ManageIQ REST API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/reference/kasparov/methods_available_for_automation/index.html">
      Methods Available for Automation
    </a>
    
  </li>


      </ul>
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc user_doc">
      

      <div class="doc-content">
        
        <div class="doc-versions">
          <span class="label">Versions: </span>
          
            <span>
              <a href="/docs/reference/latest/appliance_hardening_guide/index.html">
                Latest
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="/docs/reference/lasker/appliance_hardening_guide/index.html">
                Lasker
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span class="active" >
              <a href="/docs/reference/kasparov/appliance_hardening_guide/index.html">
                Kasparov
              </a>
            </span>
            
              <span class="separator">/</span>
            
          
            <span>
              <a href="/docs/reference/jansa/appliance_hardening_guide/index.html">
                Jansa
              </a>
            </span>
            
          
        </div>
        
        <ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#appliance-hardening-guide">Appliance Hardening Guide</a></li>
<li class="toc-entry toc-h1"><a href="#introduction-to-hardening-manageiq">Introduction to Hardening ManageIQ</a>
<ul>
<li class="toc-entry toc-h2"><a href="#ssh-security">SSH Security</a>
<ul>
<li class="toc-entry toc-h3"><a href="#setting-the-root-password-on-the-appliance">Setting the Root Password on the Appliance</a></li>
<li class="toc-entry toc-h3"><a href="#setting-ssh-keys-on-the-appliance">Setting SSH Keys on the Appliance</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#appliance-security">Appliance Security</a>
<ul>
<li class="toc-entry toc-h3"><a href="#setting-the-password-for-the-administrative-user">Setting the Password for the Administrative User</a></li>
<li class="toc-entry toc-h3"><a href="#configuring-host-based-access-control-rules-on-your-ipa-server">Configuring Host-Based Access Control Rules on your IPA Server</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#server-security">Server Security</a>
<ul>
<li class="toc-entry toc-h3"><a href="#configuring-firewall-ports">Configuring Firewall Ports</a></li>
<li class="toc-entry toc-h3"><a href="#generating-ssl-certificates-for-your-appliance-and-database">Generating SSL Certificates for Your Appliance and Database</a>
<ul>
<li class="toc-entry toc-h4"><a href="#creating-a-certificate-signing-request">Creating a Certificate Signing Request</a></li>
<li class="toc-entry toc-h4"><a href="#creating-a-self-signed-certificate">Creating a Self-signed Certificate</a></li>
<li class="toc-entry toc-h4"><a href="#enabling-your-certificate">Enabling Your Certificate</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#creating-custom-encryption-keys">Creating Custom Encryption Keys</a></li>
<li class="toc-entry toc-h3"><a href="#applying-scap-standards">Applying SCAP Standards</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#database-security">Database Security</a>
<ul>
<li class="toc-entry toc-h3"><a href="#restricting-hosts-access-to-the-database">Restricting Hosts Access to the Database</a></li>
<li class="toc-entry toc-h3"><a href="#configuring-the-database-to-use-ssl">Configuring the Database to use SSL</a>
<ul>
<li class="toc-entry toc-h4"><a href="#hardening-tls-protocol-version">Hardening TLS Protocol Version</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul><h1 id="appliance-hardening-guide">
<a class="anchor" href="#appliance-hardening-guide" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appliance Hardening Guide</h1>

<h1 id="introduction-to-hardening-manageiq">
<a class="anchor" href="#introduction-to-hardening-manageiq" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction to Hardening ManageIQ</h1>

<p>The ManageIQ appliance is distributed as a virtual machine image,
which provides users with a simple installation process. The appliance
also contains a set of factory default settings that can expose
appliances to vulnerabilities if left unset. This guide provides a set
of procedures to enhance security on your ManageIQ appliance.
This ensures your appliance has enhanced protection against any
unwarranted intrusion.</p>

<p>It is recommended to perform these steps immediately after installing
all appliances in your infrastructure.</p>

<h2 id="ssh-security">
<a class="anchor" href="#ssh-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>SSH Security</h2>

<h3 id="setting-the-root-password-on-the-appliance">
<a class="anchor" href="#setting-the-root-password-on-the-appliance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting the Root Password on the Appliance</h3>

<p>The ManageIQ appliance is a virtual machine image that runs on a
Red Hat Enterprise Linux-based operating system. This means users can
access the base operating system through SSH. This is why it is
advisable to change the default password. Continuing to use the default
password leaves the appliance vulnerable to any user attempting to gain
root access.</p>

<p>Changing the <code class="language-plaintext highlighter-rouge">root</code> password on the appliance ‘uses’ <code class="language-plaintext highlighter-rouge">the</code> same process
as changing any user password on a Linux-based system.</p>

<ol>
  <li>
    <p>Access your appliance through SSH as the <code class="language-plaintext highlighter-rouge">root</code> user:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[user@localhost ~]$ ssh root@10.1.1.205
</code></pre></div>    </div>

    <p>Substitute <code class="language-plaintext highlighter-rouge">10.1.1.205</code> with the address of your appliance.</p>
  </li>
  <li>
    <p>Enter the <code class="language-plaintext highlighter-rouge">passwd</code> command, which changes the password for the
current user:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ ~]# passwd
</code></pre></div>    </div>
  </li>
  <li>
    <p>Enter and Confirm and new password for the <code class="language-plaintext highlighter-rouge">root</code> user.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Changing password for user root.
New password: ************
Confirm password: ************
</code></pre></div>    </div>
  </li>
  <li>
    <p>Log out of the appliance.</p>
  </li>
</ol>

<p>The ManageIQ appliance now has a non-default <code class="language-plaintext highlighter-rouge">root</code> password.
This prevents unauthorized access to your appliance through SSH.</p>

<h3 id="setting-ssh-keys-on-the-appliance">
<a class="anchor" href="#setting-ssh-keys-on-the-appliance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting SSH Keys on the Appliance</h3>

<p>Another recommended practice is to use SSH keys to access the appliance
from a single machine. An SSH key provides access from one machine to
another through the SSH protocol. The following procedure shows how to
create an SSH key on your local machine and add it to the appliance.</p>

<ol>
  <li>
    <p>Check the <code class="language-plaintext highlighter-rouge">.ssh/</code> directory in your home directory for any existing
key pairs:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[user@localhost ~]$ ls ~/.ssh/
</code></pre></div>    </div>

    <p>A key pair usually consists of two files. One file is the private
key, which stays on your local machine, and the other is the public
key, which you copy to another machine. But files are named the same
except the public key ends with a <code class="language-plaintext highlighter-rouge">.pub</code> extension.</p>

    <p>If a key pair already exists, you can use this key pair. Otherwise,
use the next few steps to create your own.</p>
  </li>
  <li>
    <p>On your local machine, start the key pair generation process using
the <code class="language-plaintext highlighter-rouge">ssh-keygen</code> command:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[user@localhost ~]$ ssh-keygen -t rsa
</code></pre></div>    </div>
  </li>
  <li>
    <p>A prompt asks for the file and location to store these keys:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Enter file in which to save the key (/home/user/.ssh/id_rsa):
</code></pre></div>    </div>

    <p>Accept the default path if you do not have a <code class="language-plaintext highlighter-rouge">id_rsa</code> key pair.</p>
  </li>
  <li>
    <p>Another prompt asks for a passphrase:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Enter passphrase (empty for no passphrase):
</code></pre></div>    </div>

    <p>This encrypts the key pair with a password. This protects the key
pair if it ever falls into the wrong hands. Alternatively, you can
leave the passphrase empty, which provides an automatic login
between your local machine and the remote machine.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">ssh-keygen</code> command generates two files:</p>

    <ul>
      <li>
        <p>The private key - the default is <em>/home/user/.ssh/id_rsa</em></p>
      </li>
      <li>
        <p>The public key - the default is <em>/home/user/.ssh/id_rsa.pub</em></p>

        <p>Copy the public key to the appliance using the <code class="language-plaintext highlighter-rouge">ssh-copy-id</code>
command:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[user@localhost ~]$ ssh-copy-id ~/.ssh/id_rsa.pub root@10.1.1.205
</code></pre></div>        </div>

        <p>The command copies the public key to the appliance. You might
receive a prompt for the password of the root user on the
appliance.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>Test the SSH key authentication:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[user@localhost ~]$ ssh root@10.1.1.205
</code></pre></div>    </div>

    <p>This authenticates using the SSH key pair. If you entered a
passphrase for the key, the command prompts you for the passphrase.</p>
  </li>
  <li>
    <p>As an additional security measure, edit the <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code>
on the appliance and modify the following parameter:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>PermitRootLogin without-password
</code></pre></div>    </div>

    <p>This forces the <code class="language-plaintext highlighter-rouge">root</code> user account to use certificates instead of
passwords for SSH login. This means only your local system can
access the appliance.</p>
  </li>
</ol>

<p>The appliance now restricts access to only a single machine using the
SSH key.</p>

<h2 id="appliance-security">
<a class="anchor" href="#appliance-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Appliance Security</h2>

<h3 id="setting-the-password-for-the-administrative-user">
<a class="anchor" href="#setting-the-password-for-the-administrative-user" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting the Password for the Administrative User</h3>

<p>ManageIQ uses a unique <code class="language-plaintext highlighter-rouge">admin</code> user to control all functions in
the web-based user interface. After installing the appliance, change the
default password of the <code class="language-plaintext highlighter-rouge">admin</code> to restrict administrative access to the
appliance’s UI.</p>

<p>Changing the <code class="language-plaintext highlighter-rouge">admin</code> password uses the same process as changing any
standard user in the appliance.</p>

<ol>
  <li>
    <p>Access the appliance through your web browser and log in.</p>
  </li>
  <li>
    <p>Click <img src="../images/config-gear.png" alt="config gear"> (<strong>Configuration</strong>).</p>
  </li>
  <li>
    <p>In the accordion tree on the left, click on <strong>Access Control</strong>, then
select the <strong>Administrator</strong> under the <strong>Users</strong> section. This
displays the details for the <code class="language-plaintext highlighter-rouge">admin</code> user.</p>
  </li>
  <li>
    <p>On the details page, select menu:Configuration[Edit this user]
from the toolbar.</p>
  </li>
  <li>
    <p>Enter a new password in the <strong>Change Password / Confirm Password</strong>
fields.</p>
  </li>
  <li>
    <p>Click <strong>Save</strong> at the bottom of the page.</p>
  </li>
  <li>
    <p>Log out of the user interface.</p>
  </li>
  <li>
    <p>Test your new password by logging into the user interface.
Additionally, test your new password in the appliance console.</p>
  </li>
</ol>

<p>The ManageIQ appliance now has a non-default <code class="language-plaintext highlighter-rouge">admin</code> password.
This restricts access to your appliance’s administrative functions.</p>

<h3 id="configuring-host-based-access-control-rules-on-your-ipa-server">
<a class="anchor" href="#configuring-host-based-access-control-rules-on-your-ipa-server" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring Host-Based Access Control Rules on your IPA Server</h3>

<p>ManageIQ provides support for external authentication using an
IPA server. However, there are certain recommendations to enhance
security to your appliance, such as creating a specific user group and
host group that can access the appliance authentication service.</p>

<p>Run the following steps on your IPA server:</p>

<ol>
  <li>
    <p>Create a user group and restrict access to only the ManageIQ
users:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ipa ~]# ipa group-add manageiq_users --desc="manageiq Users"
[root@ipa ~]# ipa group-add-member manageiq_users --users=testuser1,testuser2
</code></pre></div>    </div>
  </li>
  <li>
    <p>Create a host group and restrict access to your appliance hosts:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ipa ~]# ipa hostgroup-add manageiq_hosts --desc "ManageIQ hosts"
[root@ipa ~]# ipa hostgroup-add-member manageiq_hosts --hosts=appliance1.example.com,appliance2.example.com
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add rules to allow the host group and user group access to the
ManageIQ HTTP service:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ipa ~]# ipa hbacrule-add manageiq_access --srchostcat=all
[root@ipa ~]# ipa hbacrule-add-service manageiq_access --hbacsvcs httpd-auth
[root@ipa ~]# ipa hbacrule-add-user manageiq_access --groups manageiq_users
[root@ipa ~]# ipa hbacrule-add-host manageiq_access --hostgroups manageiq_hosts
</code></pre></div>    </div>
  </li>
  <li>
    <p>Remove the default rule on your IPA server to allow access to all:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ipa ~]# ipa hbacrule-disable allow_all
</code></pre></div>    </div>
  </li>
</ol>

<p>This ensures only users in the <code class="language-plaintext highlighter-rouge">manageiq_users</code> group can
access the authentication service (<code class="language-plaintext highlighter-rouge">http-auth</code>) on the appliances in the
<code class="language-plaintext highlighter-rouge">manageiq_hosts</code> host group.</p>

<h2 id="server-security">
<a class="anchor" href="#server-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Server Security</h2>

<h3 id="configuring-firewall-ports">
<a class="anchor" href="#configuring-firewall-ports" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring Firewall Ports</h3>

<p>A new appliance starts with a few standard ports open:</p>

<ul>
  <li>
    <p>22 for SSH communication</p>
  </li>
  <li>
    <p>80 for HTTP access to the appliance</p>
  </li>
  <li>
    <p>443 for HTTPS access to the appliance</p>
  </li>
  <li>
    <p>5432 for the appliance database</p>
  </li>
</ul>

<p>You might need to restrict or open access to certain services on your
appliance in the future. In such situations, use the following method:</p>

<ul>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">firewalld</code> to enable a service or port, specifying the zone in
use. For example, to open the LDAP port:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@ ~]# firewall-cmd --zone=manageiq --permanent --add-port=389/tcp
</code></pre></div>    </div>
  </li>
</ul>

<p>The following table lists the appliance’s main services and their
respective ports.</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Administrator (Internet Browser)</td>
      <td>CFME appliance (User Interface)</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td>Access to CFME appliance User Interface</td>
    </tr>
    <tr>
      <td>Administrator (Internet Browser)</td>
      <td>CFME appliance (User Interface)</td>
      <td>HTTP</td>
      <td>80</td>
      <td> </td>
      <td>Redirect Web Browser to HTTPS service (443)</td>
    </tr>
    <tr>
      <td>Service Catalog or other integration through Web Service</td>
      <td>CFME appliance (Web Service)</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td>Access to CFME appliance Web Service</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>NFS Server</td>
      <td>NFS</td>
      <td>2049</td>
      <td>2049</td>
      <td>Embedded NFS VM scanning</td>
    </tr>
    <tr>
      <td>CFME appliance (User Interface)</td>
      <td>Any Virtual Machine</td>
      <td>TCP</td>
      <td>903</td>
      <td> </td>
      <td>VM Remote Console (if using MKS plug-in)</td>
    </tr>
    <tr>
      <td>CFME appliance (User Interface)</td>
      <td>Any Virtual Machine</td>
      <td>TCP</td>
      <td>5900-5999</td>
      <td> </td>
      <td>VM Remote Console (if using VNC)</td>
    </tr>
    <tr>
      <td>CFME appliance (any role)</td>
      <td>CFME appliance running the VMDB</td>
      <td>PostgreSQL Named Pipes</td>
      <td>5432</td>
      <td> </td>
      <td>CFME appliance connectivity to the CFME Database (PostgreSQL)</td>
    </tr>
    <tr>
      <td>CFME Subordinate Region VMDB appliance (Database Operations)</td>
      <td>CFME Master Region VMDB appliance</td>
      <td>PostgreSQL Named Pipes</td>
      <td>5432</td>
      <td> </td>
      <td>Regional VMDB node replication up to Master VMDB node (PostgreSQL only)</td>
    </tr>
    <tr>
      <td>CFME Subordinate Region VMDB appliance</td>
      <td>CFME Master Region VMDB appliance (Web Services and/or User Interface)</td>
      <td>PostgreSQL Named Pipes</td>
      <td>5432</td>
      <td> </td>
      <td>Subscription validation (PostgreSQL only)</td>
    </tr>
    <tr>
      <td>CFME appliance(Authentication through LDAP)</td>
      <td>LDAP Server (AD or other)</td>
      <td>LDAP</td>
      <td>389</td>
      <td> </td>
      <td>LDAP integration</td>
    </tr>
    <tr>
      <td>CFME appliance (Authentication through LDAPs)</td>
      <td>LDAP Server (AD or other)</td>
      <td>LDAPs</td>
      <td>636</td>
      <td> </td>
      <td>LDAPS integration</td>
    </tr>
    <tr>
      <td>SNMP Agent</td>
      <td>CFME appliance (Notifier)</td>
      <td>SNMP (UDP)</td>
      <td> </td>
      <td>161</td>
      <td>SNMP Polling</td>
    </tr>
    <tr>
      <td>CFME appliance (Notifier)</td>
      <td>SNMP Server</td>
      <td>SNMP (TCP)</td>
      <td>162</td>
      <td> </td>
      <td>SNMP Trap Send</td>
    </tr>
    <tr>
      <td>CFME appliance (Notifier)</td>
      <td>Mail server</td>
      <td>SMTP</td>
      <td>25</td>
      <td> </td>
      <td>SNMP Trap Send</td>
    </tr>
    <tr>
      <td>CFME appliance (any role)</td>
      <td>NTP Server</td>
      <td>NTP</td>
      <td> </td>
      <td>123</td>
      <td>Time Source</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>CFME SmartProxy installed on VMware ESX Server</td>
      <td>HTTPS</td>
      <td>1139</td>
      <td> </td>
      <td>Communication with SmartProxy</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>DNS Server</td>
      <td>UDP</td>
      <td> </td>
      <td>53</td>
      <td>DNS Lookups</td>
    </tr>
  </tbody>
</table>

<p>Ports Used by ManageIQ</p>

<p>The following tables detail the ports used by ManageIQ to
communicate with providers.</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME appliance (SmartProxy)</td>
      <td>RHEV-M Server</td>
      <td>HTTPS</td>
      <td>8443</td>
      <td> </td>
      <td>API communications to RHEV-M environment (Inventory, Operations, SmartProxy)</td>
    </tr>
    <tr>
      <td>CFME appliance (C\&amp;U)</td>
      <td>RHEV-M Server</td>
      <td>PostgreSQL</td>
      <td>5432</td>
      <td> </td>
      <td>RHEV-M History Database (Database connectivity not enabled by default). See <a href="https://access.redhat.com/site/solutions/63277">How to access the RHEV-M Postgres DB from a remote machine</a>.</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHEV-H Hosts or RHEL Hypervisors</td>
      <td>SSH</td>
      <td>22</td>
      <td> </td>
      <td>SSH connections.</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHEV-H Hosts or RHEL Hypervisors</td>
      <td>DirectLUN</td>
      <td> </td>
      <td> </td>
      <td>Direct LUN hook must be installed and enabled for embedded VM scanning on FC or iSCSI storage devices. Not a tcp/udp connection.</td>
    </tr>
  </tbody>
</table>

<p>Red Hat Enterprise Virtualization Ports Used by ManageIQ</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (Keystone)</td>
      <td>HTTP REST API</td>
      <td>5000</td>
      <td> </td>
      <td>Authentication and Service Entry Point</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (Nova)</td>
      <td>HTTP REST API</td>
      <td>8774</td>
      <td> </td>
      <td>Compute Resources</td>
    </tr>
    <tr>
      <td>CFME appliance (C\&amp;U)</td>
      <td>RHOS (Ceilometer)</td>
      <td>HTTP REST API</td>
      <td>8777</td>
      <td> </td>
      <td>Metrics for Capacity and Utilization</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (Glance)</td>
      <td>HTTP REST API</td>
      <td>9292</td>
      <td> </td>
      <td>Authentication and Service Entry Point</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (AMQP)</td>
      <td>AMQP</td>
      <td>5672</td>
      <td> </td>
      <td>Events Integration</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (Neutron)</td>
      <td>HTTP REST API</td>
      <td>9696</td>
      <td> </td>
      <td>Networking</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>RHOS (Cinder)</td>
      <td>HTTP REST API</td>
      <td>8776</td>
      <td> </td>
      <td>Block Storage</td>
    </tr>
  </tbody>
</table>

<p>Red Hat OpenStack Platform Ports Used by ManageIQ</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME Appliance</td>
      <td>OpenShift Master Node(s) (or Load Balancer)</td>
      <td>HTTPS</td>
      <td>8443 or 443</td>
      <td> </td>
      <td>Required for communication to the OpenShift API. Dependent on OpenShift configuration.</td>
    </tr>
    <tr>
      <td>CFME Appliance</td>
      <td>OpenShift Infrastructure Node(s) (or Load Balancer)</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td>Metrics and logging</td>
    </tr>
  </tbody>
</table>

<p>OpenShift Container Platform Ports Used by ManageIQ</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME appliance(Management System Inventory, Management System Operations, C &amp; U Data Collection, SmartProxy)</td>
      <td>vCenter</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td>CFME appliance running any of these roles will initiate communication with vCenter on this port</td>
    </tr>
    <tr>
      <td>CFME appliance (SmartProxy)</td>
      <td>ESX, ESXi Host</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td>CFME appliance</td>
    </tr>
    <tr>
      <td>CFME appliance (SmartProxy)</td>
      <td>ESX Hosts (if analyzing VMs through host)</td>
      <td>SOAP over HTTPS</td>
      <td>902</td>
      <td> </td>
      <td>Communication from CFME appliance to hosts</td>
    </tr>
    <tr>
      <td>CFME appliance (SmartProxy)</td>
      <td>vCenter (if analyzing VMs through VC)</td>
      <td>SOAP over HTTPS</td>
      <td>902</td>
      <td> </td>
      <td>Communication from CFME appliance to vCenters</td>
    </tr>
    <tr>
      <td>CFME appliance(SmartProxy)</td>
      <td>ESX Hosts (not needed for ESXi)</td>
      <td>SSH</td>
      <td>22</td>
      <td> </td>
      <td>CFME appliance console access (ssh) to ESX hosts</td>
    </tr>
  </tbody>
</table>

<p>VMware vSphere Ports Used by ManageIQ</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME appliance</td>
      <td>Hyper-V Host (VMM agent)</td>
      <td>WinRM/RPC/NetBIOS/SMB (over TCP)</td>
      <td>80/135/139/445</td>
      <td> </td>
      <td>Communication from CFME appliance to Host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Hyper-V Host (file transfer)</td>
      <td>HTTPS (using BITS)</td>
      <td>443</td>
      <td> </td>
      <td>Communication from CFME appliance to Host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>VM Guest Agent (file transfer)</td>
      <td>HTTPS (using BITS)</td>
      <td>443</td>
      <td> </td>
      <td>Communication from CFME appliance to VM Guest Agent</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>VMware ESX 3.0/3.5 Host (file transfer)</td>
      <td>SFTP</td>
      <td>22</td>
      <td> </td>
      <td>Communication from CFME appliance to ESX Host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>VMware ESXi Host (file transfer)</td>
      <td>SSH/HTTPS (using BITS)</td>
      <td>443</td>
      <td> </td>
      <td>Communication from CFME appliance to ESX Host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>WSUS Server (data channel)</td>
      <td>HTTP</td>
      <td>80/443</td>
      <td> </td>
      <td>Communication from CFME appliance to Server</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>SQL Server database (remote)</td>
      <td>TDS</td>
      <td>1433</td>
      <td> </td>
      <td>CFME appliance connectivity to the Database</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Load Balancer</td>
      <td>Load balancer config provider</td>
      <td>80/443</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Hyper-V host in untrusted domain or perimeter network (File Transfer)</td>
      <td>TCP</td>
      <td>443</td>
      <td> </td>
      <td>CFME appliance connectivity to the host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Hyper-V Host (file transfer)</td>
      <td>BITS</td>
      <td>443</td>
      <td> </td>
      <td>Communication from CFME appliance to Host</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>VMware Web Services</td>
      <td>WCF</td>
      <td>443</td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>SCVMM Ports Used by ManageIQ</p>

<table>
  <thead>
    <tr>
      <th>Initiator (CFME Role if applicable)</th>
      <th>Receiver (CFME Role if applicable)</th>
      <th>Application</th>
      <th>TCP Port</th>
      <th>UDP Port</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CFME appliance</td>
      <td>SQL Management (*.database.windows.net)</td>
      <td>TDS</td>
      <td>1433</td>
      <td> </td>
      <td>CFME appliance connectivity to the Database</td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Upload into Storage (*.blob.core.windows.net)</td>
      <td>HTTP/HTTPS</td>
      <td>80/443</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Service Bus Relay HTTP Mode (*.servicebus.windows.net)</td>
      <td>SB over HTTP</td>
      <td>80</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Service Bus Pubsub over REST (*.servicebus.windows.net)</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>CFME appliance</td>
      <td>Access Control (*.accesscontrol.windows.net)</td>
      <td>HTTPS</td>
      <td>443</td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Azure Ports Used by ManageIQ</p>

<div class="important">

To provide your ManageIQ infrastructure with an extra layer of
security, use a network layer firewall to restrict port access.

</div>

<h3 id="generating-ssl-certificates-for-your-appliance-and-database">
<a class="anchor" href="#generating-ssl-certificates-for-your-appliance-and-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating SSL Certificates for Your Appliance and Database</h3>

<p>It is important to enhance the security of SSL communication of your appliances, which, depending on your setup, may include your database appliance. The appliance image ships with a default SSL certificate. It is recommended to replace this certificate with your own certificate, either signed by a trusted Certificate Authority (CA) or self-signed.</p>

<h4 id="creating-a-certificate-signing-request">
<a class="anchor" href="#creating-a-certificate-signing-request" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a Certificate Signing Request</h4>

<p>The first step is to determine the host name of your appliance or database appliance by running the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hostname
</code></pre></div></div>

<p>The next step is to create a Certificate Signing Request (CSR) using the <code class="language-plaintext highlighter-rouge">openssl</code> command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ ~]# openssl req -new -newkey rsa:2048 -out appliance.csr -keyout appliance.key
</code></pre></div></div>

<p>This command generates a 2048-bit RSA private key and asks for a passphrase for the key.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Generating a 2048 bit RSA private key
..................+++
...........................+++
writing new private key to 'appliance.key'
Enter PEM pass phrase: **********
Verifying - Enter PEM pass phrase: **********
</code></pre></div></div>

<p>The command then provides a questionnaire requesting certain details for the key. Fill out this questionnaire. Use the output of the <code class="language-plaintext highlighter-rouge">hostname</code> command to specify the <code class="language-plaintext highlighter-rouge">Common Name</code>.</p>

<p>For example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Country Name (2 letter code) [XX]:US
State or Province Name (full name) []:North Carolina
Locality Name (eg, city) [Default City]:Raleigh
Organization Name (eg, company) [Default Company Ltd]:ManageIQ
Organizational Unit Name (eg, section) []:Customer Content Services
Common Name (eg, your name or your server's hostname) []:$(hostname)
Email Address []:example@example.com

Please enter the following 'extra' attributes to be sent with your certificate request
A challenge password []:
An optional company name []:
</code></pre></div></div>

<p>Running the command produces two files:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">appliance.key</code> - The private key</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">appliance.csr</code> - The Certificate Signing Request (CSR)</p>
  </li>
</ul>

<p>At this stage, you would send the CSR to a trusted Certificate Authority (CA) and in return they would send you a signed certificate.</p>

<h4 id="creating-a-self-signed-certificate">
<a class="anchor" href="#creating-a-self-signed-certificate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating a Self-signed Certificate</h4>

<p>As an alternative to obtaining a signed certificate, you can use the <code class="language-plaintext highlighter-rouge">appliance.key</code> and <code class="language-plaintext highlighter-rouge">appliance.csr</code> files to create a self-signed certificate by running the following <code class="language-plaintext highlighter-rouge">openssl</code> commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ ~]# openssl rsa -in appliance.key -out server.cer.key
[root@ ~]# openssl x509 -in appliance.csr -out server.cer -req -signkey server.cer.key -days 3650
</code></pre></div></div>

<p>This produces two files:</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">server.cer.key</code> - The private key for your signed certificate</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">server.cer</code> - The self-signed certificate</p>
  </li>
</ul>

<h4 id="enabling-your-certificate">
<a class="anchor" href="#enabling-your-certificate" aria-hidden="true"><span class="octicon octicon-link"></span></a>Enabling Your Certificate</h4>

<p>Despite whether you used a trusted CA or self-signed the certificate, you should now have your own certificate for your appliance.</p>

<p>Copy the certificate and key files to the certificate directory on the appliance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ ~]# cp ~/server.cer.key /var/www/miq/vmdb/certs/server.cer.key
[root@ ~]# cp ~/server.cer /var/www/miq/vmdb/certs/server.cer
</code></pre></div></div>

<p>After the certificate and key files have been copied, restart the appliance:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@ ~]# systemctl restart evmserverd
</code></pre></div></div>

<p>The appliance now uses your own certificate.</p>

<p>If your environment consists of multiple appliances connecting to a single database appliance, you can use your certificate and key files to set up SSL for the database connection. For more information, see <a href="#_chap_red_hat_cloudforms_security_guide_setting_ssl_for_the_database_appliance">Configuring the Database to use SSL</a>.</p>

<p><strong>Important:</strong></p>

<p>Updates from the Red Hat Content Delivery Network might overwrite these certificate and key files. Make sure to copy your own certificate and key files to the certificate directory after performing an update to your appliance.</p>

<p><strong>Note:</strong></p>

<p>See also the following article for information on replacing SSL certificates in ManageIQ :
<a href="https://access.redhat.com/articles/449033">https://access.redhat.com/articles/449033</a>.</p>

<h3 id="creating-custom-encryption-keys">
<a class="anchor" href="#creating-custom-encryption-keys" aria-hidden="true"><span class="octicon octicon-link"></span></a>Creating Custom Encryption Keys</h3>

<p>To avoid storing passwords in plain text, ManageIQ appliances use
an encryption key to encode and decode passwords. Each appliance stores
the key in the <code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/certs/v2_key</code>. Changing the encryption
key is recommended during setting up new ManageIQ appliances
only.</p>

<div class="important">

Red Hat does not recommend changing the encryption key for an existing
appliance as the ability to decrypt the password will be lost, affecting
all stored passwords in ManageIQ.

</div>

<p>To generate a new encryption key:</p>

<ol>
  <li>
    <p>Log in to the console of your master appliance as the <code class="language-plaintext highlighter-rouge">root</code> user.</p>
  </li>
  <li>
    <p>Run the <code class="language-plaintext highlighter-rouge">appliance_console</code> command. The ManageIQ appliance
information screen appears.</p>
  </li>
  <li>
    <p>Press any key to view the appliance menu.</p>
  </li>
  <li>
    <p>Select <strong>Generate Custom Encryption Key</strong>.</p>
  </li>
  <li>
    <p>A prompt asks if for confirmation to overwrite the existing key.
Enter <code class="language-plaintext highlighter-rouge">Y</code>.</p>
  </li>
  <li>
    <p>Enter <code class="language-plaintext highlighter-rouge">1</code> for <code class="language-plaintext highlighter-rouge">1) Create key</code>.</p>
  </li>
  <li>
    <p>The appliance generates the new key. Press any key to complete this
procedure.</p>
  </li>
</ol>

<p>This completes the procedure for generating the new key. If you have
external ManageIQ appliances, you must share this key to ensure
your whole ManageIQ infrastructure is using consistent
encryption. Failure to use the same key results in encryption and
decryption problems.</p>

<p>To copy an encryption key:</p>

<ol>
  <li>
    <p>Log in to the console of an external appliance as the <code class="language-plaintext highlighter-rouge">root</code> user.</p>
  </li>
  <li>
    <p>Run the <code class="language-plaintext highlighter-rouge">appliance_console</code> command. The ManageIQ appliance
information screen appears.</p>
  </li>
  <li>
    <p>Press any key to view the appliance menu.</p>
  </li>
  <li>
    <p>Select <strong>Generate Custom Encryption Key</strong>.</p>
  </li>
  <li>
    <p>A prompt asks if for confirmation to overwrite the existing key.
Enter <code class="language-plaintext highlighter-rouge">Y</code>.</p>
  </li>
  <li>
    <p>Select <code class="language-plaintext highlighter-rouge">Fetch key from remote machine</code>.</p>
  </li>
  <li>
    <p>Enter the hostname or IP address of the master appliance.</p>
  </li>
  <li>
    <p>Enter the username for SSH access to the master appliance. Use the
default <code class="language-plaintext highlighter-rouge">root</code> user.</p>
  </li>
  <li>
    <p>Enter the password for SSH access to the master appliance.</p>
  </li>
  <li>
    <p>Enter the location of the remote key. Accept the default as
<code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/certs/v2_key</code>.</p>
  </li>
  <li>
    <p>The appliance copies the new key from the remote server. Press any
key to complete this procedure.</p>
  </li>
</ol>

<p>After distributing the new key, all appliances require an update to the
database configuration. For all appliances, log in as the <code class="language-plaintext highlighter-rouge">root</code> user
and run the following commands replacing <code class="language-plaintext highlighter-rouge">dbpassword</code> with your database
password:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[root@{productname_short_l} ~]# fix_auth --databaseyml --hostname localhost --password dbpassword
[root@{productname_short_l} ~]# systemctl restart evmserverd
</code></pre></div></div>

<p>This completes the new encryption key generation for your
ManageIQ infrastructure.</p>

<h3 id="applying-scap-standards">
<a class="anchor" href="#applying-scap-standards" aria-hidden="true"><span class="octicon octicon-link"></span></a>Applying SCAP Standards</h3>

<p>The Security Content Automation Protocol (SCAP) is a set of standards to
assist with vulnerability management and policy compliance.
ManageIQ provides a set of SCAP standards to apply to your
appliance. View these SCAP rules in the
<code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/productization/appliance_console/config/scap_rules.yml</code>
file.</p>

<p>To apply the SCAP standards to your appliance’s server:</p>

<ol>
  <li>
    <p>Log in to the appliance as the <code class="language-plaintext highlighter-rouge">root</code> user.</p>
  </li>
  <li>
    <p>Enter the <code class="language-plaintext highlighter-rouge">appliance_console</code> command. The ManageIQ Appliance
summary screen displays.</p>
  </li>
  <li>
    <p>Press <code class="language-plaintext highlighter-rouge">Enter</code> to manually configure settings.</p>
  </li>
  <li>
    <p>Select <code class="language-plaintext highlighter-rouge">Harden Appliance Using SCAP Configuration</code>.</p>
  </li>
  <li>
    <p>The appliance console displays the following:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>Harden Appliance Using SCAP Configuration

Locking down the appliance for SCAP...
</code></pre></div>    </div>

    <p>The appliance applies the SCAP settings from the <code class="language-plaintext highlighter-rouge">scap_rules.yml</code>
file.</p>
  </li>
  <li>
    <p>When complete, press any key to return to the summary screen.</p>
  </li>
</ol>

<p>The appliance now meets the SCAP standards set in the <code class="language-plaintext highlighter-rouge">scap_rules.yml</code>
file.</p>

<h2 id="database-security">
<a class="anchor" href="#database-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Database Security</h2>

<h3 id="restricting-hosts-access-to-the-database">
<a class="anchor" href="#restricting-hosts-access-to-the-database" aria-hidden="true"><span class="octicon octicon-link"></span></a>Restricting Hosts Access to the Database</h3>

<p>Strengthening the host-based authentication (HBA) settings on a database
appliance helps with preventing unauthorized access from external hosts.
The HBA settings restrict access to an IP address range so that only
hosts within that range have access.</p>

<p>Restricting access to the database requires modifications to the
<code class="language-plaintext highlighter-rouge">/var/lib/pgsql/data/pg_hba.conf</code> file. This file contains a text-based
table with some initial settings:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># TYPE    DATABASE USER  ADDRESS       METHOD
local     all      all                 peer map=usermap
host      all      all   all           md5
#hostssl  all      all   all           md5
</code></pre></div></div>

<p>This format for this table uses the following header columns:</p>

<ul>
  <li>
    <p>TYPE
This defines the access type, either local access from the database
host (<code class="language-plaintext highlighter-rouge">local</code>), remote access from an external host regardless of
encryption (<code class="language-plaintext highlighter-rouge">host</code>), external access with encryption (<code class="language-plaintext highlighter-rouge">hostssl</code>), or
external access without encryption (<code class="language-plaintext highlighter-rouge">nohostssl</code>).</p>
  </li>
  <li>
    <p>DATABASE
The name of the database the host can access. Use <code class="language-plaintext highlighter-rouge">all</code> for all
databases.</p>
  </li>
  <li>
    <p>USER
The name of the user the host can use to access the database. Use
<code class="language-plaintext highlighter-rouge">all</code> for all users.</p>
  </li>
  <li>
    <p>ADDRESS
The IP address of the host or address range of hosts with access to
the database. This can either be:</p>

    <ul>
      <li>
        <p>A single address:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>host    all      all   192.168.1.10           md5
</code></pre></div>        </div>
      </li>
      <li>
        <p>An address range using a CIDR mask:</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>host    all      all   192.168.1.0/24           md5
</code></pre></div>        </div>
      </li>
      <li>
        <p>An address range using a separate subnet mask value</p>

        <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>host    all      all   192.168.1.0  255.255.255.0            md5
</code></pre></div>        </div>

        <p><strong>Note:</strong></p>

        <p><code class="language-plaintext highlighter-rouge">ADDRESS</code> is not required for <code class="language-plaintext highlighter-rouge">local</code> connections.</p>
      </li>
    </ul>
  </li>
  <li>
    <p>METHOD
The authentication method, which includes:</p>

    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">trust</code> - Allow the connection unconditionally. This method
allows anyone that can connect to the PostgreSQL database server
to login as any PostgreSQL user they wish, without the need for
a password or any other authentication.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">reject</code> - Reject the connection unconditionally. This is useful
for “filtering out” certain hosts from a group, for example a
<code class="language-plaintext highlighter-rouge">reject</code> line could block a specific host from connecting, while
a later line allows the remaining hosts in a specific network to
connect.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">md5</code> - Require the client to supply an MD5-encrypted password
for authentication.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">password</code> - Require the client to supply an unencrypted
password for authentication. Since the password is sent in clear
text over the network, this should not be used on untrusted
networks.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">ident</code> - Obtain the operating system user name of the client by
contacting the ident server on the client and check if it
matches the requested database user name. Ident authentication
can only be used on TCP/IP connections. When specified for local
connections, peer authentication will be used instead.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">peer</code> - Obtain the client’s operating system user name from the
operating system and check if it matches the requested database
user name. This is only available for local connections.</p>
      </li>
    </ul>
  </li>
</ul>

<p>Using a combination of these options, you create a series of rules that
govern which hosts can access your database and which hosts are denied.
For example, you might change the default HBA rules to only allow remote
access to the ManageIQ database (<code class="language-plaintext highlighter-rouge">vmdb_production</code>) from hosts in
a certain subnet. The modified HBA table would looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># TYPE  DATABASE          USER  ADDRESS         METHOD
local   all               all                   peer map=usermap
host    vmdb_production   all   192.168.1.0/24  md5
#hostssl all              all   all             md5
</code></pre></div></div>

<p>These restrictions help when structuring your ManageIQ appliances
in relationships. For example, use these database restrictions to grant
access only between a master database appliance in one region and
appliances connecting from a separate region.</p>

<h3 id="configuring-the-database-to-use-ssl">
<a class="anchor" href="#configuring-the-database-to-use-ssl" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuring the Database to use SSL</h3>

<p>ManageIQ initially connects to the database through an unencrypted communication. If you are using multiple appliances that are connecting to a single database appliance, you can set up the database connection to use SSL. An SSL connection encrypts the communication between the ManageIQ and the database.</p>

<p>The procedures in this section use the SSL certificate and the following key files. These files can be found on your main ManageIQ database appliance.</p>

<p><strong>Note:</strong></p>

<p>The appliance image ships with a default SSL certificate and it is recommended to change this certificate. You can use a certificate that is signed by a trusted CA, or generate a self-signed certificate.</p>

<p>For more information, see the <a href="#generating-ssl-certificates-for-your-appliance-and-database">Generating SSL Certificates section</a>.</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/certs/server.cer</code> - Signed or self-signed certificate for the database appliance.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/certs/server.cer.key</code> - Private key for server certificate.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/var/www/miq/vmdb/certs/root.crt</code> - The root CA certificate used to sign the CA certificate for the ManageIQ database. You can either use a self-signed certificate or a certificate that is signed by a trusted CA to generate your root certificate.</p>
  </li>
</ul>

<p>It is also recommended to stop all ManageIQ services before configuring the database to use SSL.</p>

<p>To configure SSL on the database appliance:</p>

<ol>
  <li>
    <p>Log in as <code class="language-plaintext highlighter-rouge">root</code> to the appliance where the database resides.</p>
  </li>
  <li>
    <p>Stop the <code class="language-plaintext highlighter-rouge">evmserverd</code> and <code class="language-plaintext highlighter-rouge">postgresql</code> services:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@appliance2 ~]# systemctl stop evmserverd
[root@appliance2 ~]# systemctl stop postgresql.service
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the server key file in the correct location and set the ownership and permissions for it:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@appliance2 ~]# install -m 600 -o postgres -g postgres \
/var/www/miq/vmdb/certs/server.cer.key /var/www/miq/vmdb/certs/postgres.key
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the server certificate file in the correct location and set the ownership and permissions for it:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@appliance2 ~]# install -m 644 -o postgres -g postgres \
/var/www/miq/vmdb/certs/server.cer /var/www/miq/vmdb/certs/postgres.crt
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install the database appliance certificate file as the root certificate in the correct location and set the ownership and
permissions for it.</p>

    <p>If you are using a self-signed certificate, run:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@appliance2 ~]# install -m 644 -o postgres -g postgres /var/www/miq/vmdb/certs/server.cer /var/www/miq/vmdb/certs/root.crt
</code></pre></div>    </div>

    <p>If you are using a third-party certificate, edit this command to install your root certificate.</p>
  </li>
  <li>
    <p>Make sure that the security context is set correctly for the files in <code class="language-plaintext highlighter-rouge">/var/www/miq/certs</code>:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@appliance2 ~]# restorecon -R -v /var/www/miq/vmdb/certs
</code></pre></div>    </div>
  </li>
  <li>
    <p>Open the <code class="language-plaintext highlighter-rouge">/var/lib/pgsql/data/postgresql.conf</code> file and uncomment and edit the <code class="language-plaintext highlighter-rouge">ssl</code> option:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ssl=on
</code></pre></div>    </div>

    <p>In the same file, locate the options <code class="language-plaintext highlighter-rouge">ssl_cert_file</code>, <code class="language-plaintext highlighter-rouge">ssl_key_file</code>, and <code class="language-plaintext highlighter-rouge">ssl_ca_file</code> that specify the location of SSL
certificates and edit them so that they are uncommented and point to the correct certificate files:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>ssl_cert_file = '/var/www/miq/vmdb/certs/postgres.crt'  # (change requires restart)
ssl_key_file  = '/var/www/miq/vmdb/certs/postgres.key'  # (change requires restart)
ssl_ca_file   = '/var/www/miq/vmdb/certs/root.crt'      # (change requires restart)
</code></pre></div>    </div>
  </li>
  <li>
    <p>Open the <code class="language-plaintext highlighter-rouge">/var/lib/pgsql/data/pg_hba.conf</code> file and locate the two lines that contain:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>host      all      all   all           md5
#hostssl  all      all   all           md5
</code></pre></div>    </div>

    <p>Modify the two lines to comment the <code class="language-plaintext highlighter-rouge">host</code> entry and uncomment the <code class="language-plaintext highlighter-rouge">hostssl</code> entry:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>#host     all      all   all           md5
hostssl   all      all   all           md5
</code></pre></div>    </div>

    <p>This changes the incoming communication protocol to use SSL and refuse any unencrypted PostgreSQL connections.</p>
  </li>
  <li>
    <p>Start the <code class="language-plaintext highlighter-rouge">postgresql</code> and <code class="language-plaintext highlighter-rouge">evmserverd</code> services so that the changes take effect:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@manageiq1 ~]# systemctl start postgresql.service
[root@manageiq1 ~]# systemctl start evmserverd
</code></pre></div>    </div>
  </li>
</ol>

<p>The database appliance now accepts only connections from connecting appliances that use SSL. The following procedure sets up connecting appliances to communicate to the database by using SSL. Use this procedure for each connecting appliance:</p>

<ol>
  <li>
    <p>Log in as <code class="language-plaintext highlighter-rouge">root</code> to the connecting appliance.</p>
  </li>
  <li>
    <p>Create the <code class="language-plaintext highlighter-rouge">.postgresql</code> directory in your <code class="language-plaintext highlighter-rouge">root</code> user home directory.</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@manageiq2 ~]# mkdir /root/.postgresql
</code></pre></div>    </div>

    <p>The PostgreSQL client library, which ManageIQ also uses, looks to this directory for custom configuration files.</p>
  </li>
  <li>
    <p>Copy the root certificate file from the database appliance to the <code class="language-plaintext highlighter-rouge">/root/.postgresql</code> directory on the connecting appliance:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@manageiq2 ~]# scp root@[database_appliance_fqdn]:/var/www/miq/vmdb/certs/root.crt /root/.postgresql/root.crt
</code></pre></div>    </div>

    <p>Where <code class="language-plaintext highlighter-rouge">[database_appliance_fqdn]</code> is the fully qualified domain name of the database appliance.</p>
  </li>
  <li>
    <p>Test the connection between the connecting appliance and the database appliance by using the <code class="language-plaintext highlighter-rouge">psql</code>command:</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>[root@localhost ~]# psql -h [database_appliance_fqdn] -d vmdb_production
Password: ********
psql (9.2.8)
SSL connection (cipher: DHE-RSA-AES256-SHA, bits: 256)
Type "help" for help.

vmdb_production=#
</code></pre></div>    </div>

    <p>The <code class="language-plaintext highlighter-rouge">psql</code> displays information about the SSL connection, which indicates that the configuration succeeded. Enter <code class="language-plaintext highlighter-rouge">\q</code> to leave <code class="language-plaintext highlighter-rouge">psql</code>.</p>
  </li>
</ol>

<p>Complete this procedure for each external appliance. This enhances the security of all database transactions in your ManageIQ infrastructure.</p>

<h4 id="hardening-tls-protocol-version">
<a class="anchor" href="#hardening-tls-protocol-version" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hardening TLS Protocol Version</h4>

<p>After configuring the database to use SSL, protocol TLS version 1.2 is used as default. The older versions of this protocol (TLS 1.0 and 1.1) are still available for clients to choose. You can disable older versions by inserting the following lines into
<code class="language-plaintext highlighter-rouge">/var/lib/pgsql/data/postgresql.conf</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssl_ciphers = 'TLSv1.2:!aNULL'
ssl_prefer_server_ciphers=true
</code></pre></div></div>



      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2021 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
