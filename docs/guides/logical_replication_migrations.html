<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <script>
    stored_theme = localStorage.getItem('miq-theme');
    theme        = stored_theme && JSON.parse(localStorage.getItem('miq-theme'));

    if (theme === "light-theme") {
      document.querySelector('html').classList.add("light-theme");
    }

    if (theme === "dark-theme") {
      document.querySelector('html').classList.add("dark-theme");
    }
  </script>

  <link type="text/css" rel="stylesheet" href="/assets/main-364a522e6cb5aa31700d9562491465966c2c1081a61b11529597f13bf81cfb69.css">
  <link rel="canonical" href="http://manageiq.org/docs/guides/logical_replication_migrations">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/guides/logical_replication_migrations">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li>
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li class="active">
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<ul class="menu menu-toplevel" id="guides_menu">

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Architecture
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/capacity_and_utilization_collection_explanation.html">
      Capacity And Utilization Collection Explanation
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/enterprise.html">
      Enterprise
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/source_code_layout.html">
      Source Code Layout
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Developer Setup
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/plugins.html">
      Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/running_test_suites.html">
      Running Test Suites
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/debugging.html">
      Interactive debugging
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      External Auth
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/configuration.html">
      Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/installation.html">
      Installation
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      User Interface
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/patterns.html">
      UI Patterns
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/plugins.html">
      UI Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/register_react_component.html">
      Shared React Component API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/report_data_api.html">
      Report Data API
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Providers
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_overview.html">
      Providers Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_database_architecture.html">
      Providers Database Architecture
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/amazon_aws_config.html">
      Amazon AWS Config
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/containers.html">
      Containers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openshift.html">
      Openshift
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openstack_infra_provider.html">
      Openstack Infra Provider
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/provisioning/windows_imaging.html">
      Windows Imaging
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/coding_style_and_standards.html">
      Coding Style And Standards
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/i18n.html">
      I18n
    </a>
    
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc dev_doc">
      

      <div class="doc-content">
        
        <h1 id="testing-logical-replication-with-migrations">Testing logical replication with migrations</h1>

<h2 id="introduction">Introduction</h2>

<p>ManageIQ uses logical replication to provide central administrative functions over objects in other
database regions.  In order to do this, postgresql’s logical replication is used to setup
publications for specific tables in remote regions and subscriptions for each in the central or
global region.</p>

<p>Note, this is completely different from HA and failover.  Logical replication provides product
features such as being able to start or stop a virtual machine centrally regardless of which
database it resides in.  HA, on the other hand, provides for failover by promoting a backup when a
primary database fails.</p>

<p>This interconnectedness of multiple databases with publications and subscriptions with ManageIQ
regions means that the upgrade process is a bit different.  Basically, the global region cannot be
migrated until all databases it’s subscribing to have been migrated.  Fortunately, this logic
should be mostly automatic.</p>

<p>This logic is what we’re trying to test and verify.</p>

<h2 id="pre-requisites">Pre-requisites</h2>

<p>This was tested with 3 nightly appliances.  They were setup to be at the Jansa codebase with
replication. The appliances were then migrated to kasparov.  This document could be used for
different branches or tags.</p>

<p>The following region numbers were used and will be referenced throughout this document.  Replace
these values if different numbers are selected:</p>
<ul>
  <li>99 - global</li>
  <li>1 - remote</li>
  <li>2 - remote</li>
</ul>

<p>It is assumed the application will be run in production mode on appliances.  This is the default
on appliances.  If using a different mode or not appliances, RAILS_ENV will need to be exported:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export RAILS_ENV=production
</code></pre></div></div>

<h2 id="initial-setup">Initial setup</h2>

<ul>
  <li>The existing manageiq code from the rpm in /var/www/miq/vmdb was renamed</li>
  <li>ManageIQ was cloned and checked out at the jansa branch</li>
  <li>Now, install all rpms required to build compiled gems:</li>
</ul>

<p>These commands were found in the <a href="https://github.com/ManageIQ/manageiq-rpm_build/blob/ec0fcc85f7d24010278148f4bab83447d18884b5/Dockerfile#L22-L45">rpm_build Dockerfile</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    dnf -y group install "development tools" &amp;&amp; \
    dnf config-manager --setopt=epel.exclude=*qpid-proton* --setopt=tsflags=nodocs --save &amp;&amp; \
    dnf -y install \
      ansible \
      cmake \
      copr-cli \
      glibc-langpack-en \
      libcurl-devel \
      libpq-devel \
      librdkafka \
      libssh2-devel \
      libxml2-devel \
      libxslt-devel \
      nodejs \
      openssl-devel \
      platform-python-devel \
      postgresql-server \
      postgresql-server-devel \
      qpid-proton-c-devel \
      ruby-devel \
      rubygem-bundler \
      wget \
      sqlite-devel &amp;&amp; \
    dnf clean all
</code></pre></div></div>

<h2 id="prepare-for-replication-on-jansa">Prepare for replication on jansa</h2>

<p>The commands below will be run on each appliance and will do the following:</p>
<ul>
  <li>Checkout the source version (jansa)</li>
  <li>Bundle the gem dependencies</li>
  <li>Initialize the encryption key and default database.yml</li>
  <li>Setup the region number</li>
  <li>Seed the database</li>
</ul>

<p>Note: Setting RAILS_ENV is not required on appliances as they default to production, but is provided
below for completeness.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export DISABLE_DATABASE_ENVIRONMENT_CHECK=1
vmdb
git checkout origin/jansa
bundle check || bundle update
mkdir log
cp -f certs/v2_key.dev certs/v2_key
cp -f config/database.pg.yml config/database.yml
bundle exec rake evm:db:region -- --region XXX
bundle exec rake --trace  db:migrate
bundle exec rake --trace  db:seed
</code></pre></div></div>

<p>Substitute XXX for the region number of this appliance:</p>
<ul>
  <li>99 - global</li>
  <li>1 - remote</li>
  <li>2 - remote</li>
</ul>

<h2 id="configure-replication-for-jansa">Configure replication for jansa</h2>

<ul>
  <li>Region 1 and 2:
    <ul>
      <li>These will be remotes, meaning they will “publish” the tables to be replicated:</li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmdb
bin/rails r "MiqRegion.replication_type= :remote"
</code></pre></div>    </div>
  </li>
  <li>Region 99 (global):
    <ul>
      <li>The commands below will:
        <ul>
          <li>Provide the other regions’ connection information</li>
          <li>Create the subscription for each remote region</li>
        </ul>
      </li>
    </ul>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/rails c
</code></pre></div>    </div>

    <p>Subsitute the proper values below:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ require 'miq_pglogical'
host1 = 'x.x.x.x'
host2 = 'y.y.y.y'
port = '5432'
user = 'root'
password = 'zzz'
sub1 = PglogicalSubscription.new(:host =&gt; host1, :port =&gt; port, :user =&gt; user, :dbname =&gt; 'vmdb_production', :password =&gt; password)
sub2 = PglogicalSubscription.new(:host =&gt; host2, :port =&gt; port, :user =&gt; user, :dbname =&gt; 'vmdb_production', :password =&gt; password)
MiqPglogical.save_global_region([sub1, sub2], [])
</code></pre></div>    </div>
  </li>
</ul>

<p>Now, replication can verified before moving on.</p>

<p>On the global:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin/rails c
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User.all.pluck(:id)
# This should show ids beginning with the 3 region numbers: 99, 1, 2.
</code></pre></div></div>

<p>Note, it may take a few minutes before these users are replicated.</p>

<h2 id="remove-replication-before-upgrade">Remove replication before upgrade</h2>

<p>Whenever performing an upgrade, logical replication must be disabled on the old version and enabled
again on the new version.  Often, this is because appliances are replaced and therefore the
publication and subscription are different.  Even when not replacing appliances, it is still best to
disable replication on the old version and enable it again on the new version so that the correct
version of code is adding the publications and subscriptions.</p>

<p>On the global, assuming the remotes are region 1 and 2:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>psql -U root vmdb_production -h global_ipaddress -c 'DROP subscription region_1_subscription;'
psql -U root vmdb_production -h global_ipaddress -c 'DROP subscription region_2_subscription;'
</code></pre></div></div>

<p>Note:  Dropping the subscription on the global will also delete the replication slot on the remote
and will do proper cleanup.  The replication slot should not be manually removed.</p>

<h2 id="upgrade-to-kasparov">Upgrade to kasparov</h2>

<p>On region 1, 2, and 99:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmdb
git checkout origin/kasparov
bundle check || bundle update
</code></pre></div></div>

<h2 id="configure-replication-for-kasparov">Configure replication for kasparov</h2>

<p>Follow the same instructions as <a href="#configure-replication-for-jansa">above</a></p>

<h2 id="attempt-migration-from-global">Attempt migration from global</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmdb
bin/rake db:migrate
</code></pre></div></div>

<p>Notice that the global will not migrate the database as it is waiting on region 1 to migrate first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Waiting for remote region 1 to run migration 20200424183342
</code></pre></div></div>

<p>Leave region 1’s terminal waiting for the other regions to migrate…</p>

<h2 id="migrate-database-to-kasparov-on-region-1">Migrate database to kasparov on region 1</h2>

<p>On region 1:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmdb
bin/rake db:migrate
</code></pre></div></div>

<p>Now, region 99 (global) terminal shows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Waiting for remote region 1 to run migration 20200424183342
Waiting for remote region 2 to run migration 20200424183342
</code></pre></div></div>

<p>It is now waiting on region 2 and will not complete yet.</p>

<h2 id="migrate-database-to-kasparov-on-region-2">Migrate database to kasparov on region 2</h2>

<p>On region 2:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vmdb
bin/rake db:migrate
</code></pre></div></div>

<p>After region 2 migrates, region 99 will immediately migrate.</p>

      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2021 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
