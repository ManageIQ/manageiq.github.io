<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <script>
    stored_theme = localStorage.getItem('miq-theme');
    theme        = stored_theme && JSON.parse(localStorage.getItem('miq-theme'));

    if (theme === "light-theme") {
      document.querySelector('html').classList.add("light-theme");
    }

    if (theme === "dark-theme") {
      document.querySelector('html').classList.add("dark-theme");
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="http://manageiq.org/docs/guides/providers/events">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa-solid fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa-solid fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa-solid theme-toggle" data-toggle-theme></button>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/guides/providers/events">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li>
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li class="active">
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<ul class="menu menu-toplevel" id="guides_menu">

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Architecture
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/capacity_and_utilization_collection_explanation.html">
      Capacity And Utilization Collection Explanation
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/enterprise.html">
      Enterprise
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/source_code_layout.html">
      Source Code Layout
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Developer Setup
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/plugins.html">
      Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/running_test_suites.html">
      Running Test Suites
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/debugging.html">
      Interactive debugging
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      External Auth
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/configuration.html">
      Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/installation.html">
      Installation
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      User Interface
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/patterns.html">
      UI Patterns
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/plugins.html">
      UI Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/register_react_component.html">
      Shared React Component API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/report_data_api.html">
      Report Data API
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Providers
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_overview.html">
      Providers Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_database_architecture.html">
      Providers Database Architecture
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/amazon_aws_config.html">
      Amazon AWS Config
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/containers.html">
      Containers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openshift.html">
      Openshift
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openstack_infra_provider.html">
      Openstack Infra Provider
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/provisioning/windows_imaging.html">
      Windows Imaging
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/coding_style_and_standards.html">
      Coding Style And Standards
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/i18n.html">
      I18n
    </a>
    
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc dev_doc">
      

      <div class="doc-content">
        
        <h2 id="events">Events</h2>

<p>Events are one of the primary functions of a provider, in addition to Inventory, Metrics, and Operations.  Adding an event catcher to your provider is extremely helpful for improving overall performance of the system because it allows us to react to changes as they happen rather than resort to polling.</p>

<p>There are three primary uses for events in MIQ:</p>

<ol>
  <li>Allowing users to trigger custom event-condition-action via the automate event switchboard</li>
  <li>Displaying the event timeline for a resource on the UI</li>
  <li>Triggering provider refresh</li>
</ol>

<p>We’ll primarily focus on #3 here since the first two come “for free” once you start creating events but initiating a provider refresh (particularly a targeted refresh) takes a bit more work.</p>

<h3 id="overview">Overview</h3>

<p>All provider events use the <code class="language-plaintext highlighter-rouge">EmsEvent</code> model which derives from the <code class="language-plaintext highlighter-rouge">EventStream</code> base class.  There are also internal <code class="language-plaintext highlighter-rouge">MiqEvent</code>s but we are going to focus on <code class="language-plaintext highlighter-rouge">EmsEvent</code>s.</p>

<p>The pipeline for catching, parsing, and saving events is optimized to ensure that the chance of missing an event is minimized.</p>

<p>To that end catching and parsing events is separate from saving them to the database and relating them to other inventory.  Typically providers even implement catching and parsing in different threads within the event catcher.</p>

<p>The overall flow looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(Native Provider)  ---&gt;   (Event Catcher Thread)  ----&gt;  (Event Catcher Parser)  -----&gt;  (MiqEventHandler)  -&gt; (VMDB)
               Emits an event                  Internal Queue                 MiqQueue.put
</code></pre></div></div>

<h3 id="writing-an-event-catcher">Writing an Event Catcher</h3>

<p>First we need to set up the worker scaffolding so that we can run our event catcher worker.</p>

<p><code class="language-plaintext highlighter-rouge">config/settings.yml</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">:ems</span><span class="pi">:</span>
  <span class="na">:ems_awesome_cloud</span><span class="pi">:</span>
    <span class="na">:blacklisted_event_names</span><span class="pi">:</span> <span class="pi">[]</span>
    <span class="na">:event_handling</span><span class="pi">:</span>
      <span class="na">:event_groups</span><span class="pi">:</span> <span class="pi">{}</span> <span class="c1"># Add your event names under the appropriate groups here</span>

<span class="na">:workers</span><span class="pi">:</span>
  <span class="na">:worker_base</span><span class="pi">:</span>
    <span class="na">:event_catcher</span><span class="pi">:</span>
      <span class="na">:event_catcher_awesome_cloud</span><span class="pi">:</span>
        <span class="na">:poll</span><span class="pi">:</span> <span class="s">15.seconds</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/cloud_manager/event_catcher.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ManageIQ::Providers::AwesomeCloud::CloudManager::EventCatcher</span> <span class="o">&lt;</span> <span class="no">ManageIQ</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">BaseManager</span><span class="o">::</span><span class="no">EventCatcher</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/cloud_manager/event_catcher/runner.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ManageIQ::Providers::AwesomeCloud::CloudManager::EventCatcher::Runner</span> <span class="o">&lt;</span> <span class="no">ManageIQ</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">BaseManager</span><span class="o">::</span><span class="no">EventCatcher</span><span class="o">::</span><span class="no">Runner</span>
  <span class="c1"># This is the main method run in the first thread by the core event catcher runner.</span>
  <span class="c1"># It is responsible for retrieving events from the provider and putting them on</span>
  <span class="c1"># an internal queue for the core runner thread to parse and put on MiqQueue.</span>
  <span class="k">def</span> <span class="nf">monitor_events</span>
    <span class="c1"># Start up our event monitor</span>
    <span class="n">event_monitor_handle</span><span class="p">.</span><span class="nf">start</span>

    <span class="c1"># Tell the core runner thread that the event monitor is started.  The worker</span>
    <span class="c1"># won't be marked as "running" until this happens.</span>
    <span class="n">event_monitor_running</span>

    <span class="c1"># And finally poll for events.  This should be implemented as a blocking method</span>
    <span class="c1"># which yields events caught from the provider</span>
    <span class="n">event_monitor_handle</span><span class="p">.</span><span class="nf">poll</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
      <span class="vi">@queue</span><span class="p">.</span><span class="nf">enq</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">ensure</span>
    <span class="n">stop_event_monitor</span>
  <span class="k">end</span>

  <span class="c1"># This method is called by core when shutting down the event catcher</span>
  <span class="k">def</span> <span class="nf">stop_event_monitor</span>
    <span class="n">event_monitor_handle</span><span class="p">.</span><span class="nf">stop</span>
  <span class="k">end</span>

  <span class="c1"># This is called by the core runner thread to parse and put the event on the queue.</span>
  <span class="k">def</span> <span class="nf">queue_event</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">event_hash</span> <span class="o">=</span> <span class="no">ManageIQ</span><span class="o">::</span><span class="no">Providers</span><span class="o">::</span><span class="no">AwesomeCloud</span><span class="o">::</span><span class="no">CloudManager</span><span class="o">::</span><span class="no">EventParser</span><span class="p">.</span><span class="nf">event_to_hash</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="vi">@cfg</span><span class="p">[</span><span class="ss">:ems_id</span><span class="p">])</span>
    <span class="no">EmsEvent</span><span class="p">.</span><span class="nf">add_queue</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span> <span class="vi">@cfg</span><span class="p">[</span><span class="ss">:ems_id</span><span class="p">],</span> <span class="n">event_hash</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># The Stream class isn't a requirement but helps to encapsulate the logic of</span>
  <span class="c1"># fetching events from the provider.</span>
  <span class="k">def</span> <span class="nf">event_monitor_handle</span>
    <span class="vi">@event_monitor_handle</span> <span class="o">||=</span> <span class="k">begin</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">module_parent</span><span class="o">::</span><span class="no">Stream</span><span class="p">.</span><span class="nf">new</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The Stream implementation is going to be very specific to your provider, this is just an example of how one might look.</p>

<p><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/cloud_manager/event_catcher/stream.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ManageIQ::Providers::AwesomeCloud::CloudManager::EventCatcher::Stream</span>
  <span class="nb">attr_reader</span> <span class="ss">:ems</span><span class="p">,</span> <span class="ss">:stop_polling</span><span class="p">,</span> <span class="ss">:poll_sleep</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">ems</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{})</span>
    <span class="vi">@ems</span> <span class="o">=</span> <span class="n">ems</span>
    <span class="vi">@stop_polling</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="vi">@poll_sleep</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="ss">:poll_sleep</span><span class="p">]</span> <span class="o">||</span> <span class="mi">20</span><span class="p">.</span><span class="nf">seconds</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">start</span>
    <span class="vi">@stop_polling</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">stop</span>
    <span class="vi">@stop_polling</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">poll</span>
    <span class="n">since</span> <span class="o">=</span> <span class="kp">nil</span>

    <span class="kp">loop</span> <span class="k">do</span>
      <span class="n">ems</span><span class="p">.</span><span class="nf">with_provider_connection</span><span class="p">(</span><span class="ss">:service</span> <span class="o">=&gt;</span> <span class="s2">"Events"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">events_client</span><span class="o">|</span>
        <span class="c1"># Replace with your provider's events API</span>
        <span class="n">events</span> <span class="o">=</span> <span class="n">events_client</span><span class="p">.</span><span class="nf">get_events</span><span class="p">(</span><span class="ss">:since</span> <span class="o">=&gt;</span> <span class="n">since</span><span class="p">)</span>
        <span class="n">since</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">utc</span>

        <span class="k">break</span> <span class="k">if</span> <span class="n">stop_polling</span>

        <span class="n">events</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span> <span class="k">yield</span> <span class="n">event</span> <span class="p">}</span>
      <span class="k">end</span>
      <span class="nb">sleep</span><span class="p">(</span><span class="n">poll_sleep</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="parsing-events">Parsing events</h3>

<p>Now that we’re catching events from the provider we need to implement the parser.  This is called by the main event catcher runner thread prior to putting events onto MiqQueue for the MiqEventHandler to process.</p>

<p>The purpose of this is similar to the inventory parser, to translate the native provider event into the VMDB schema.</p>

<p><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/cloud_manager/event_parser.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">ManageIQ::Providers::AwesomeCloud::CloudManager::EventParser</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">event_to_hash</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">ems_id</span><span class="p">)</span>
    <span class="n">event_hash</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:event_type</span> <span class="o">=&gt;</span> <span class="n">event</span><span class="p">[</span><span class="ss">:event_name</span><span class="p">],</span>
      <span class="ss">:source</span>     <span class="o">=&gt;</span> <span class="s2">"AWESOME_CLOUD"</span><span class="p">,</span>
      <span class="ss">:ems_ref</span>    <span class="o">=&gt;</span> <span class="n">event</span><span class="p">[</span><span class="ss">:id</span><span class="p">],</span>
      <span class="ss">:timestamp</span>  <span class="o">=&gt;</span> <span class="n">event</span><span class="p">[</span><span class="ss">:time</span><span class="p">],</span>
      <span class="ss">:full_data</span>  <span class="o">=&gt;</span> <span class="n">event</span><span class="p">,</span>  <span class="c1"># Make sure this serializes properly and isn't dumping a native object</span>
    <span class="p">}</span>

    <span class="c1"># Parse any additional information e.g. instances, images, etc...</span>
    <span class="k">case</span> <span class="n">event_hash</span><span class="p">[</span><span class="ss">:event_type</span><span class="p">]</span>
    <span class="k">when</span> <span class="sr">/com.awesome-cloud.vm/</span>
      <span class="n">parse_vm_event!</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">event_hash</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">event_hash</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">parse_vm_event!</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">event_hash</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="ss">:vm</span><span class="p">].</span><span class="nf">nil?</span>

    <span class="c1"># The uid_ems/ems_ref should match the attributes that you set in the inventory</span>
    <span class="c1"># parser since they will be used to lookup the VM object by the MiqEventHandler</span>
    <span class="n">event_hash</span><span class="p">[</span><span class="ss">:vm_uid_ems</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:vm</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">event_hash</span><span class="p">[</span><span class="ss">:vm_ems_ref</span><span class="p">]</span> <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:vm</span><span class="p">,</span> <span class="ss">:id</span><span class="p">)</span>
    <span class="n">event_hash</span><span class="p">[</span><span class="ss">:vm_name</span><span class="p">]</span>    <span class="o">=</span> <span class="n">event</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="ss">:vm</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And with that you should be able to catch events and have them saved to the database!</p>

<p>To test this out you can run <code class="language-plaintext highlighter-rouge">simulate_queue_worker</code> in a rails console (this will act as your <code class="language-plaintext highlighter-rouge">MiqEventHandler</code>) and then your can run you event catcher with <code class="language-plaintext highlighter-rouge">run_single_worker</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lib/workers/bin/run_single_worker.rb --role=event --ems-id=2 ManageIQ::Providers::AwesomeCloud::CloudManager::EventCatcher
</code></pre></div></div>

<h3 id="using-events-for-targeted-refresh">Using events for targeted refresh</h3>

<p>This is where things get interesting, combining an event catcher with targeted refresh allows you to automatically build the <code class="language-plaintext highlighter-rouge">InventoryRefresh::Target</code> that we saw in the <a href="targeted_refresh">Targeted Refresh Guide</a> based on the event data.  You can also use the event payload to pre-seed your targeted collector with information to save on API calls.</p>

<p>The first step is to create automate event handlers for each of the events that you want to trigger a targeted refresh.  These live in the https://github.com/ManageIQ/manageiq-content repository.</p>

<p>Create a directory to hold your events: <code class="language-plaintext highlighter-rouge">content/automate/ManageIQ/System/Event/EmsEvent/AWESOME_CLOUD.class/</code></p>

<p>Then in this directory create a file that matches the event_type for each of your events:
<code class="language-plaintext highlighter-rouge">content/automate/ManageIQ/System/Event/EmsEvent/AWESOME_CLOUD.class/com.awesomecloud.vm.create.yaml</code></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">object_type</span><span class="pi">:</span> <span class="s">instance</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">1.0</span>
<span class="na">object</span><span class="pi">:</span>
  <span class="na">attributes</span><span class="pi">:</span>
    <span class="na">display_name</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">com.awesomecloud.vm.create</span>
    <span class="na">inherits</span><span class="pi">:</span>
    <span class="na">description</span><span class="pi">:</span>
    <span class="na">relative_path</span><span class="pi">:</span> <span class="s">System/Event/EmsEvent/AWESOME_CLOUD/com.awesomecloud.vm.create</span>
  <span class="na">fields</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">rel4</span><span class="pi">:</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/System/event_handlers/refresh"</span> <span class="c1"># This action is what will kick off a targeted refresh</span>
</code></pre></div></div>

<p>With that in place the <code class="language-plaintext highlighter-rouge">MiqEventHandler</code> is going to invoke automate, and automate is going to call the refresh event_handler.</p>

<p>For this to work we have to expose a way for core to convert our provider event to a list of refresh targets.  This is done with the <code class="language-plaintext highlighter-rouge">EventTargetParser</code> class.</p>

<p><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/cloud_manager/event_target_parser.rb</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ManageIQ::Providers::AwesomeCloud::CloudManager::EventTargetParser</span>
  <span class="nb">attr_reader</span> <span class="ss">:ems_event</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">ems_event</span><span class="p">)</span>
    <span class="vi">@ems_event</span> <span class="o">=</span> <span class="n">ems_event</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse</span>
    <span class="n">target_collection</span> <span class="o">=</span> <span class="no">InventoryRefresh</span><span class="o">::</span><span class="no">TargetCollection</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="ss">:manager</span> <span class="o">=&gt;</span> <span class="n">ems_event</span><span class="p">.</span><span class="nf">ext_management_system</span><span class="p">,</span>
      <span class="ss">:event</span>   <span class="o">=&gt;</span> <span class="n">ems_event</span>
    <span class="p">)</span>

    <span class="n">raw_event</span> <span class="o">=</span> <span class="n">ems_event</span><span class="p">.</span><span class="nf">full_data</span>

    <span class="k">if</span> <span class="n">raw_event</span><span class="p">[</span><span class="ss">:vm</span><span class="p">]</span>
      <span class="n">target_collection</span><span class="p">.</span><span class="nf">add_target</span><span class="p">(</span><span class="ss">:association</span> <span class="o">=&gt;</span> <span class="ss">:vms</span><span class="p">,</span> <span class="ss">:manager_ref</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:ems_ref</span> <span class="o">=&gt;</span> <span class="n">raw_event</span><span class="p">[</span><span class="ss">:vm</span><span class="p">][</span><span class="ss">:id</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="c1"># Add in other resource types that you might want to handle here</span>

    <span class="c1"># Return the set of targets from this event</span>
    <span class="n">target_collection</span><span class="p">.</span><span class="nf">targets</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now when an event is caught the event handler should automatically queue a targeted refresh with pre-parsed targets.</p>

<p>With that you can now bump your refresh interval from 15 minutes up to 1 day.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="na">:ems_refres</span><span class="pi">:</span>
  <span class="na">:awesome_cloud</span><span class="pi">:</span>
    <span class="na">:refresh_interval</span><span class="pi">:</span> <span class="s">24.hours</span>
</code></pre></div></div>

<p>This ensures that the provider inventory doesn’t get too far out of sync while freeing up the refresh worker to process way more targeted refreshes without having to do a full every 15 minutes.</p>

      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa-solid theme-toggle" data-toggle-theme></button>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa-brands fa-github"></i>
          GitHub
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa-brands fa-gitter"></i>
          Gitter
        </a>
      </li>
      <li>
        <a href="https://github.com/orgs/ManageIQ/discussions">
          <i class="fa-solid fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2026 ManageIQ.
      </span>
      <span>
        <a href="https://www.ibm.com/opensource/" class="footer-link" target="_blank">
          Sponsored by IBM, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://x.com/ManageIQ" title="X / Twitter" class="social_link">
            <i class="fa-brands fa-x-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://bsky.app/profile/manageiq.bsky.social" title="Bluesky" class="social_link">
            <i class="fa-brands fa-bluesky"></i>
          </a>
        </li>

        <li>
          <a href="https://fosstodon.org/@manageiq" title="Mastodon" class="social_link">
            <i class="fa-brands fa-mastodon"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" title="Facebook" class="social_link">
            <i class="fa-brands fa-facebook"></i>
          </a>
        </li>

        <li>
          <a href="https://www.linkedin.com/company/manageiq" title="LinkedIn" class="social_link">
            <i class="fa-brands fa-linkedin"></i>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" title="YouTube" class="social_link">
            <i class="fa-brands fa-youtube"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa-solid fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
