<!DOCTYPE html>
<html>

  <head>
  <!DOCTYPE html>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ManageIQ</title>
  <meta name="description" content="">
  <meta property="og:image" content="http://manageiq.org/assets/images/logo/manageiq-logo-blue.png" />

  <script>
    stored_theme = localStorage.getItem('miq-theme');
    theme        = stored_theme && JSON.parse(localStorage.getItem('miq-theme'));

    if (theme === "light-theme") {
      document.querySelector('html').classList.add("light-theme");
    }

    if (theme === "dark-theme") {
      document.querySelector('html').classList.add("dark-theme");
    }
  </script>

  <link type="text/css" rel="stylesheet" href="/assets/main-72fb4f5b36dd952a472e11bcb9bd0033f67ce60d480cf7fbdcd084f2c00fa845.css">
  <link rel="canonical" href="http://manageiq.org/docs/guides/providers/adding_a_new_model">
  <link rel="alternate" type="application/rss+xml" title="ManageIQ" href="http://manageiq.org/feed.xml">

  <link href="/assets/images/favicon.ico" rel="shortcut icon">
</head>


  <body>
    <header class="site-header">
  <a href="/" class="brand">
    <span class="brand-name">ManageIQ</span>
    <img class="brand-logo" src="/assets/images/manageiq-logo-inverse.svg" alt="ManageIQ Logo">
  </a>

  <div id="site_header-nav_toggle">
    <a href="#" class="off_canvas-show" data-behavior="off_canvas-toggle">
      <i class="fa fa-bars"></i>
    </a>
  </div>

  <div class="off_canvas">
    <header class="off_canvas-header">
      <a href="#" class="off_canvas-hide" data-behavior="off_canvas-toggle">
        <i class="fa fa-times"></i>
      </a>
    </header>

    <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

  </div>
</header>


    <main data-url="/docs/guides/providers/adding_a_new_model">
      <nav class="doc_tabs">
  <ul>
  <li>
    <a href="/docs/get-started/">Get Started</a>
  </li>
  <li>
    <a href="/docs/reference/">User Reference</a>
  </li>
  <li>
    <a href="/docs/automation">
      Automation Book
    </a>
  </li>
  <li>
    <a href="/docs/api">
      API Docs
    </a>
  </li>
  <li class="active">
    <a href="/docs/guides/README">Developer Guides</a>
  </li>
</ul>

    <div class="col-lg-4 col-md-4 col-sm-12 pull-right" style="margin-top: 10px">
        <script async src="https://cse.google.com/cse.js?cx=006042792541147862616:dfkijfebdts"></script>
         <div class="gcse-search"></div>
    </div>
</nav>

<script>
  window.onload = demo;
	function demo() {
	    document.getElementById("gsc-i-id1").setAttribute("placeholder", "Search Documentation")
	}
</script>

<div class="doc_container">
  <div class="doc_menu">
    
    

<ul class="menu menu-toplevel" id="guides_menu">

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Architecture
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/capacity_and_utilization_collection_explanation.html">
      Capacity And Utilization Collection Explanation
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/enterprise.html">
      Enterprise
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/source_code_layout.html">
      Source Code Layout
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Developer Setup
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/plugins.html">
      Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/running_test_suites.html">
      Running Test Suites
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/developer_setup/debugging.html">
      Interactive debugging
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      External Auth
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth.html">
      Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/configuration.html">
      Configuration
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/external_auth/installation.html">
      Installation
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      User Interface
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/patterns.html">
      UI Patterns
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/plugins.html">
      UI Plugins
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/register_react_component.html">
      Shared React Component API
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/ui/report_data_api.html">
      Report Data API
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li class="menu-parent">
    
    <a href="#">
      Providers
    </a>
    
    
      <ul>
        



  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_overview.html">
      Providers Overview
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/architecture/providers_database_architecture.html">
      Providers Database Architecture
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/amazon_aws_config.html">
      Amazon AWS Config
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/containers.html">
      Containers
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openshift.html">
      Openshift
    </a>
    
  </li>

  
  
  
  <li class="doc_menu-item">
    <a href="/docs/guides/providers/openstack_infra_provider.html">
      Openstack Infra Provider
    </a>
    
  </li>


      </ul>
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/provisioning/windows_imaging.html">
      Windows Imaging
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/coding_style_and_standards.html">
      Coding Style And Standards
    </a>
    
    
  </li>

  
  
  
  <li>
    
    <a href="/docs/guides/i18n.html">
      I18n
    </a>
    
    
  </li>

</ul>

    
  </div>
  <div class="doc_main">
    <article class="doc dev_doc">
      

      <div class="doc-content">
        
        <h2 id="adding-a-new-model">Adding A New Model</h2>

<p>So you’ve added your AwesomeCloud provider and collected everything that ManageIQ has tables for, but your cloud is so awesome it has something ManageIQ doesn’t have yet.  In order to manage this new type of inventory in ManageIQ you have to create a new model for it.</p>

<p>Before we jump in make sure that you are familiar with the following guides:</p>
<ul>
  <li><a href="./dev-guide">dev-guide</a></li>
  <li><a href="./persister/inventory_collections">Inventory Collections</a></li>
  <li><a href="./refresh">Refresh</a></li>
</ul>

<p>As well as <a href="https://guides.rubyonrails.org/active_record_basics.html">Rails Models</a> specifically ActiveRecord and Migrations.</p>

<h3 id="create-a-new-database-table">Create a new database table</h3>
<p>Before you can add a new model, you must create a database table to store the data.  This is done by using the migration generator.</p>
<ol>
  <li>If you haven’t already, clone the manageiq-schema repository and add it to your bundler overrides.</li>
  <li>In a terminal type <code class="language-plaintext highlighter-rouge">rails generate migration create_&lt;table_names&gt;</code> (model name in plural), for instance: create_physical_storages. A migration file will be created on the vm in the repo <code class="language-plaintext highlighter-rouge">manageiq-schema</code>, in directory <code class="language-plaintext highlighter-rouge">db/migrate</code>.</li>
  <li>Edit the file and add necessary fields:
    <ol>
      <li>Use existing schema files as reference.</li>
      <li><code class="language-plaintext highlighter-rouge">ems_ref</code> is the field used for storing the id that a model record has in its provider backend db. This enables to send CRUD requests from miq back to the provider, using <code class="language-plaintext highlighter-rouge">ems_ref</code> to reference to the correct record there.</li>
      <li><code class="language-plaintext highlighter-rouge">t.references</code> are fields that hold references to other tables (foreign keys) usually a with <code class="language-plaintext highlighter-rouge">bigint</code> index. For instance, every schema should have a reference field to it <code class="language-plaintext highlighter-rouge">ems</code>:
        <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:ems</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:bigint</span><span class="p">,</span> <span class="ss">:index</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:references</span> <span class="o">=&gt;</span> <span class="ss">:ext_management_system</span>
</code></pre></div>        </div>
      </li>
    </ol>
  </li>
  <li>When the migration is ready, change directory to your core manageiq directory and run <code class="language-plaintext highlighter-rouge">rails db:migrate</code>.</li>
  <li>If you need to change something and have to re-run the migration again you can rollback a migration: <code class="language-plaintext highlighter-rouge">rails db:rollback</code>. Optional: specify the number (N) of rollbacks to perform by adding <code class="language-plaintext highlighter-rouge">STEP=N</code>.</li>
</ol>

<h3 id="create-the-new-model">Create the new Model</h3>
<p>In the main manageiq repo:</p>
<ol>
  <li>Create the model class in <code class="language-plaintext highlighter-rouge">app/models</code>:
    <ol>
      <li>Add a model class file and specify the necessary relations (<code class="language-plaintext highlighter-rouge">belongs_to</code>, <code class="language-plaintext highlighter-rouge">has_many</code>, etc.). Once again, it’s helpful to check existing models.</li>
      <li>The name of the model file should be in <code class="language-plaintext highlighter-rouge">snake_case</code> format and singular, not plural: <code class="language-plaintext highlighter-rouge">cloud_database.rb</code> and not <code class="language-plaintext highlighter-rouge">cloud_databases.rb</code>.</li>
      <li>The classes in this path are general, to be used throughout the ManageIQ platform. For behavior desired in only in a particular provider, a model can be inherited and overridden in that provider’s <code class="language-plaintext highlighter-rouge">app/models</code> dir.</li>
      <li>For instance, the general <code class="language-plaintext highlighter-rouge">cloud_database</code> in the main repo defines CRUD methods with basic behavior, common to all its implementations. However, after performing the basic common necessities, each of its CRUD methods calls another final “raw” CRUD method, which is supposed to actually perform the operation. These raw methods are left unimplemented in the general <code class="language-plaintext highlighter-rouge">cloud_database</code>, and must be implemented by a subclass in the provider’s repo.</li>
      <li>Include a <code class="language-plaintext highlighter-rouge">belongs_to :ext_management_system, :foreign_key =&gt; :ems_id, , :class_name =&gt; "ManageIQ::Providers::CloudManager"</code></li>
      <li>At the base class all features should default to <code class="language-plaintext highlighter-rouge">supports_not</code> so e.g. add <code class="language-plaintext highlighter-rouge">supports_not :create</code> to your base model.</li>
    </ol>
  </li>
  <li>Add the collection to the manager type in <code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/cloud_manager.rb</code> (replace <code class="language-plaintext highlighter-rouge">cloud_manager</code> with the relevant provider):
    <ol>
      <li>Add the <code class="language-plaintext highlighter-rouge">has_many</code> association (e.g. <code class="language-plaintext highlighter-rouge">has_many :cloud_databases</code>) as well as any modifiers you want such as <code class="language-plaintext highlighter-rouge">:dependent =&gt; destroy</code>.  <code class="language-plaintext highlighter-rouge">has_many :cloud_databases, :foreign_key =&gt; :ems_id, :dependent =&gt; :destroy</code></li>
    </ol>
  </li>
  <li>Add the new model to the inventory collections
After adding a schema and a model class, we would like to update its db table on every <code class="language-plaintext highlighter-rouge">EmsRefresh</code> with data we collect from the parallel model on the provider’s backend side.<br />
In the main manageiq repo:</li>
  <li><code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/inventory/persister/builder/cloud_manager.rb</code>:<br />
Add a method with the model’s plural name:
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cloud_databases</span>
  <span class="n">add_common_default_values</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="update-your-provider-to-collect-the-new-model">Update your provider to collect the new model</h3>

<p>In the provider repo, (e.g. <code class="language-plaintext highlighter-rouge">manageiq-providers-awesome_cloud</code>) in <code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/awesome_cloud/inventory/</code>:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">collector/cloud_manager.rb</code>: Add a method with the model’s plural name, which calls the <code class="language-plaintext highlighter-rouge">GET</code> method of the model in the provider’s client:
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cloud_databases</span>
  <span class="vi">@cloud_databases</span> <span class="o">||=</span> <span class="n">compute_client</span><span class="p">.</span><span class="nf">get_databases</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">collector/target_collection.rb</code>: Add a method with the model’s plural name, which defines and returns a container for the collection. This can be an empty <code class="language-plaintext highlighter-rouge">[]</code>, but can also include more logic if needed:
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">cloud_databases</span>
  <span class="p">[]</span>
<span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li><code class="language-plaintext highlighter-rouge">parser/cloud_manager.rb</code> (see Inventory::Parser in <a href="./refresh">Refresh</a> for examples):
    <ol>
      <li>Add the model’s plural name to the <code class="language-plaintext highlighter-rouge">parse</code> method in the top.</li>
      <li>Add a method with the model’s plural name, which calls the collector method (added in stage 2) and passes the fields that were retrieved from the client to a <code class="language-plaintext highlighter-rouge">build</code> method of the persister (which later saves them to the miq db).</li>
      <li>The parser is also the place for light processing of the data received from the client, in case it needs formatting or manipulation before it is saved to the db.</li>
    </ol>
  </li>
  <li><code class="language-plaintext highlighter-rouge">persister/cloud_databases.rb</code> Add a new call to <code class="language-plaintext highlighter-rouge">add_collection(cloud, :cloud_databases)</code>, which saves the data to the miq db. <code class="language-plaintext highlighter-rouge">cloud</code> here is the name defined in <code class="language-plaintext highlighter-rouge">app/models/manageiq/providers/inventory/persister/builder/persister_helper.rb</code> for the <code class="language-plaintext highlighter-rouge">builder_class</code> of this provider</li>
</ol>

<h3 id="add-an-api-endpoint-for-the-new-model">Add an API Endpoint for the New Model</h3>
<p>Now that we have a model with data collected from the provider’s backend, we might like to access and manipulate it without directly touching the db, by making an API request. This is necessary mainly for performing CRUD operations requested by the user through the UI, which must be passed on to the provider’s backend.</p>

<p>In the main manageiq repo in <code class="language-plaintext highlighter-rouge">db/fixtures/miq_product_features.yml</code>: Add the model by copying from existing models. Pay attention to singular vs plural when writing the name of the model: Plural in <code class="language-plaintext highlighter-rouge">:description</code>, snake_case singular in <code class="language-plaintext highlighter-rouge">:identifier</code></p>

<p>In <code class="language-plaintext highlighter-rouge">manageiq-api</code> repo:</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">app/controllers/api/</code>: Add a controller, use existing files as reference. If the only operation necessary is retrieving data, the controller can be as thin as:
    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Api</span>
  <span class="k">class</span> <span class="nc">CloudDatabaseController</span> <span class="o">&lt;</span> <span class="no">BaseController</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>    </div>
    <p>Any other operation requires adding a method to handle its request.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">config/api.yml</code>: Add the model by copying from existing models. This <code class="language-plaintext highlighter-rouge">yml</code> specifies the possible <code class="language-plaintext highlighter-rouge">GET</code> and <code class="language-plaintext highlighter-rouge">POST</code> operations available for the model, both for the whole <code class="language-plaintext highlighter-rouge">collection</code> (all the instances, or <code class="language-plaintext highlighter-rouge">resources</code> in this terminology) and for a specific <code class="language-plaintext highlighter-rouge">resource</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">spec/requests/:</code> Add a spec for testing the feature provided by the new API. Pay attention to singular vs plural when writing the name of the model, follow closely existing specs.</li>
</ol>

<h3 id="conclusion">Conclusion</h3>
<p>This is it! You’ve added a new schema and a new model, connected it to its relevant provider, integrated it into the Inventory flow to keep it updated with data from the backend, and opened up an API endpoint to perform CRUD (and custom) operations on the model, which could send requests back to the provider backend.</p>

<p>Any changes requested and performed in the backend will echo back to your ManageIQ model on the next <code class="language-plaintext highlighter-rouge">EmsRefresh</code>.</p>

      </div>
    </article>
  </div>
</div>

    </main>

    <footer class="site-footer">
  <div class="footer-row" id="footer_top">
    <div class="footer-group">
      <img class="footer-logo" src="/assets/images/manageiq-glyph-inverse.svg" alt="ManageIQ">
      <ul class="site_nav">
  <li >
    <a href="/download/">Download</a>
  </li>
  <li >
    <a href="/docs/">Documentation</a>
  </li>
  <li >
    <a href="/community/">Community</a>
  </li>
  <li >
    <a href="/blog/">Blog</a>
  </li>
  <li>
    <button class="fa theme-toggle" data-toggle-theme></i>
  </li>
</ul>

    </div>


    <ul class="contact_menu">
      <li>
        <a href="https://github.com/ManageIQ/">
          <i class="fa fa-github"></i>
          Github
        </a>
      </li>
      <li>
        <a href="https://gitter.im/ManageIQ/manageiq">
          <i class="fa fa-gitter">
            <svg viewBox="45 47 78 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 40.1 (33804) - http://www.bohemiancoding.com/sketch -->
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(45.000000, 47.000000)">
        <g id="icon-gitter" transform="translate(10.000000, 0.000000)">
            <rect id="Rectangle-path" x="0" y="0.5" width="8.25" height="61"></rect>
            <rect id="Rectangle-path" x="49.75" y="14.5" width="8.25" height="47"></rect>
            <rect id="Rectangle-path" x="16.5" y="14.5" width="8.25" height="80.25"></rect>
            <rect id="Rectangle-path" x="33.25" y="14.5" width="8.25" height="80.25"></rect>
        </g>
    </g>
</svg>

          </i>
          Gitter
        </a>
      </li>
      <li>
        <a href="http://talk.manageiq.org/">
          <i class="fa fa-comments"></i>
          Forum
        </a>
      </li>
      
    </ul>
  </div>

  <div class="footer-row" id="footer_bottom">
    <div class="footer-legal">
      <span class="copyright">
        &copy; 2023 ManageIQ.
      </span>
      <span>
        <a href="http://community.redhat.com/software/" target="_blank">
          Sponsored by Red Hat, Inc.
        </a>
      </span>
      <span>
        <a href="/logo/" class="footer-link">Logo</a>
      </span>
      <span>
        <a href="/security/" class="footer-link">Security</a>
      </span>
      <span>
        <a href="/legal/" class="footer-link">Legal &amp; Privacy</a>
      </span>
    </div>

    <div class="footer-social">
      <ul class="social_menu">
        <li>
          <a href="https://twitter.com/ManageIQ" class="social_link social_link-twitter">
            <i class="fa fa-twitter"></i>
          </a>
        </li>

        <li>
          <a href="https://www.facebook.com/manageiq/" class="social_link social_link-facebook">
            <span class="social_link-icon">
              <i class="fa fa-facebook"></i>
            </span>
          </a>
        </li>

        <!--  -->
        <li>
          <a href="https://www.linkedin.com/company/manageiq" class="social_link social_link-linkedin">
            <span class="social_link-icon">
              <i class="fa fa-linkedin"></i>
            </span>
          </a>
        </li>

        <li>
          <a href="https://www.youtube.com/user/ManageIQVideo" class="social_link social_link-youtube">
            <span class="social_link-icon">
              <i class="fa fa-youtube"></i>
            </span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    <div id="lightbox">
  <header class="lightbox-header">
    <div class="lightbox-title"></div>
    <div class="lightbox-close">
      <span class="fa fa-times"></span>
    </div>
  </header>

  <div class="lightbox-image">
    <img src="" alt="">
  </div>
</div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="/assets/js/main.js" charset="utf-8"></script>
    
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58883457-1', 'auto');
  ga('send', 'pageview');

</script>
    
  </body>
</html>
